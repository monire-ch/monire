---
import type { ComparisonCategory, PricingPlans, PricingTier } from "@/types";
import Button from "../buttons/Button.astro";
import OptimizedImage from "../utilities/OptimizedImage.astro";
import { markdownify } from "@/lib/utils/textConverter";
import AnimatedNumber from "@/components/widgets/AnimatedNumber.astro";

type Props = {
  content: PricingTier & {
    plans: PricingPlans;
    comparison?: ComparisonCategory[];
  };
  index: number;
  class?: string;
};

const {
  class: className,
  index,
  content: {
    enable,
    featured,
    comparison,
    usages,
    name,
    plans,
    description,
    price,
    features,
    ctaBtn,
    badge,
  },
  ...rest
} = Astro.props;

const selectedPlan = plans.list?.find(
  (plan: { selected: boolean }) => plan.selected,
);

const allFeatures = comparison?.map((item) => item.list).flat();

const currentPlanFeatures = allFeatures
  ?.map((item) => {
    if (item.included[index]) return item;
  })
  .filter(Boolean);

// Theme-aware text color for each card
const cardTextClass = featured ? "text-monire-deep-teal" : "text-white/88";
const cardSurfaceStyle = featured
  ? "background-image: var(--gradient-surface-soft); border-color: var(--color-border-surface-soft);"
  : "background-image: var(--gradient-surface-dark); border-color: var(--color-border-surface-dark);";
---

{
  enable && (
    <div
      class:list={[
        // Base
        "pricing-card max-lg:box-shadow-primary hover:lg:box-shadow-primary relative mt-4 flex flex-col gap-8 rounded-3xl border px-9 py-9 transition duration-500 md:mt-6",

        // Make the featured (middle) card taller + more prominent on desktop
        // - move it up a bit
        // - give it a larger min-height so it is physically taller
        { "lg:min-h-[650px] lg:-translate-y-2": featured },
        { "lg:min-h-[620px]": !featured },

        className,

        // Backgrounds
        // Base text for the whole card
        cardTextClass,
      ]}
      style={cardSurfaceStyle}
      {...rest}>
      {badge?.enable && (
        <span
          class:list={[
            "pricing-badge inline-block rounded-full px-4 py-2 text-xs font-semibold",
            { "bg-primary/10 text-primary": featured },
            { "bg-white/10 text-white": !featured },
          ]}>
          {badge.label}
        </span>
      )}

      <div class="space-y-5">
        {name && (
          <h3 class="text-h4 text-inherit" set:html={markdownify(name)} />
        )}

        {price?.map((item, usageIndex) => (
          <div
            data-plan={item.type.toLowerCase()}
            class:list={[
              "price-wrapper relative flex flex-wrap items-end gap-1.5 transition-all duration-300",
              { active: selectedPlan?.label === item.type },
              { hidden: selectedPlan?.label !== item.type && plans.enable },
              { hidden: !plans.enable && usageIndex !== 0 },
            ]}>
            <span
              class:list={[
                "pricing-from",
                { "text-[var(--color-pricing-from-featured)]": featured },
                { "text-current/84": !featured },
              ]}>
              from
            </span>

            <span class="pricing-price text-h3/none font-secondary text-mustard flex gap-0">
              <AnimatedNumber
                animateOn="click"
                transitionTime="1.2s"
                content={item}
              />
            </span>

            {featured && (
              <OptimizedImage
                class="absolute -top-10 right-0 overflow-hidden opacity-20"
                width={180}
                src="/images/pricing-card-highlighter.png"
                alt="shape"
              />
            )}
          </div>
        ))}

        <div class="space-y-5">
          {description && (
            <p class="text-current/88" set:html={markdownify(description)} />
          )}

          {usages?.map((item, i) => (
            <div
              data-plan={item.type.toLowerCase()}
              class:list={[
                "rounded-lg px-5 py-2.5 text-sm transition-all duration-300",
                { hidden: selectedPlan?.label !== item.type && plans.enable },
                { hidden: !plans.enable && i !== 0 },
                { "bg-monire-deep-teal/8": featured },
                { "bg-white/7": !featured },
              ]}>
              {item.list.map((row: { label: string; value: string }) => (
                <div class="flex flex-wrap-reverse items-center justify-between gap-5 border-b py-2 first:pt-0 last:border-b-transparent last:pb-0">
                  <span set:html={row.value} />
                  <span set:html={row.label} />
                </div>
              ))}
            </div>
          ))}
        </div>

        <div class="prose-styles has-list has-list-check prose-li:text-current prose-p:text-current prose-strong:text-current text-current">
          <ul
            class:list={[
              "list-check list-unstyled space-y-3 py-4 text-sm text-current",
              "[&>li:before]:text-mustard",
            ]}>
            {features.map((feature) => (
              <li set:html={markdownify(feature)} />
            ))}

            {currentPlanFeatures?.map(
              (item) =>
                item?.included[index] && (
                  <li class="block lg:hidden">
                    {markdownify(item.value)}
                    {typeof item.included[index] === "string" && (
                      <strong set:html={markdownify(item.included[index])} />
                    )}
                  </li>
                ),
            )}
          </ul>
        </div>

        {ctaBtn?.enable && (
          <Button
            class="w-full justify-center text-center"
            variant="primary"
            content={ctaBtn}
          />
        )}
      </div>
    </div>
  )
}
