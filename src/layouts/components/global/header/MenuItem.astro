---
import type { NavigationLink } from "@/types";
import ButtonLink from "@/layouts/components/buttons/ButtonLink.astro";

const menu = Astro.props.menu as NavigationLink;
const { pathname } = Astro.url;
---

{
  menu.name && (
    <li
      class:list={[
        "nav-item",
        { "nav-item-cta": menu.action === "openContactModal" },
      ]}
      role="menuitem">
      {menu.action === "openContactModal" ? (
        <ButtonLink
          variant="primary"
          content={{ enable: true, label: menu.name, url: "#" }}
          class="nav-link nav-link-cta uppercase font-bold"
          data-menu-action={menu.action}
        />
      ) : (
        <a
          href={menu.url || "#"}
          class:list={[
            "nav-link uppercase text-text-default font-bold",
            { "nav-link-active": pathname === menu.url },
          ]}
          data-menu-action={menu.action || null}>
          {menu.name}
        </a>
      )}
    </li>
  )
}

<script>
  function initMenuActions() {
    const menuLinks = document.querySelectorAll("[data-menu-action]");
    const navLinks = document.querySelectorAll(".nav-link");

    menuLinks.forEach((link) => {
      const action = link.getAttribute("data-menu-action");

      link.addEventListener("click", (e) => {
        if (action === "openContactModal") {
          e.preventDefault();
          window.dispatchEvent(new CustomEvent("open-contact-modal"));

          // Close mobile menu if open
          const navMenu = document.getElementById("nav-menu");
          if (navMenu?.classList.contains("open")) {
            navMenu.classList.remove("open");
            document.body.classList.remove("overflow-hidden");
          }
        }
      });
    });

    navLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        const a = link as HTMLAnchorElement;
        if (
          a.getAttribute("href") === "/" &&
          window.location.pathname === "/"
        ) {
          e.preventDefault();
          const cleanUrl = `${window.location.pathname}${window.location.search}`;
          if (window.location.hash) {
            window.history.pushState({}, "", cleanUrl);
            window.dispatchEvent(new Event("hashchange"));
          }
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      });
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMenuActions);
  } else {
    initMenuActions();
  }

  if (typeof window !== "undefined") {
    const updateActiveLinks = () => {
      const { pathname, hash } = window.location;
      const links = document.querySelectorAll(".nav-link");

      links.forEach((link) => {
        const a = link as HTMLAnchorElement;
        if (a.dataset.menuAction) {
          link.classList.remove("nav-link-active");
          return;
        }
        const linkPath = a.pathname;
        const linkHash = a.hash;

        // CASE 1 — Home "/" should ONLY be active on exact "/"
        if (linkPath === "/" && !linkHash) {
          if (pathname === "/" && !hash) {
            link.classList.add("nav-link-active");
          } else {
            link.classList.remove("nav-link-active");
          }
          return;
        }

        // CASE 2 — Hash-based links (/#services, /#pricing, etc)
        if (linkHash) {
          if (pathname === "/" && hash === linkHash) {
            link.classList.add("nav-link-active");
          } else {
            link.classList.remove("nav-link-active");
          }
          return;
        }

        // CASE 3 — Regular page links
        if (pathname === linkPath) {
          link.classList.add("nav-link-active");
        } else {
          link.classList.remove("nav-link-active");
        }
      });
    };

    window.addEventListener("load", updateActiveLinks);
    window.addEventListener("hashchange", updateActiveLinks);
  }
</script>
