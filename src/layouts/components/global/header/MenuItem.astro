---
import type { NavigationLink } from "@/types";

const menu = Astro.props.menu as NavigationLink;
const { pathname } = Astro.url;
---

{
  menu.name && (
    <li class="nav-item" role="menuitem">
      <a
        href={menu.action ? "#" : menu.url || "#"}
        class:list={[
          "nav-link text-text-default font-bold uppercase",
          { "nav-link-active": pathname === menu.url },
        ]}
        data-menu-action={menu.action || null}>
        {menu.name}
      </a>
    </li>
  )
}

<script>
  function initMenuActions() {
    const menuLinks = document.querySelectorAll("[data-menu-action]");
    const navLinks = document.querySelectorAll(".nav-link");

    menuLinks.forEach((link) => {
      const action = link.getAttribute("data-menu-action");

      link.addEventListener("click", (e) => {
        if (action === "openContactModal") {
          e.preventDefault();
          window.dispatchEvent(new CustomEvent("open-contact-modal"));

          // Close mobile menu if open
          const navMenu = document.getElementById("nav-menu");
          if (navMenu?.classList.contains("open")) {
            navMenu.classList.remove("open");
            document.body.classList.remove("overflow-hidden");
          }
        }
      });
    });

    navLinks.forEach((link) => {
      link.addEventListener("click", (e) => {
        const a = link as HTMLAnchorElement;
        if (a.getAttribute("href") === "/" && window.location.pathname === "/") {
          e.preventDefault();
          window.scrollTo({ top: 0, behavior: "smooth" });
        }
      });
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initMenuActions);
  } else {
    initMenuActions();
  }

  if (typeof window !== "undefined") {
    const updateActiveLinks = () => {
      const { pathname, hash } = window.location;
      const links = document.querySelectorAll(".nav-link");

      links.forEach((link) => {
        const a = link as HTMLAnchorElement;
        if (a.dataset.menuAction) {
          link.classList.remove("nav-link-active");
          return;
        }
        const linkPath = a.pathname;
        const linkHash = a.hash;

        // CASE 1 — Home "/" should ONLY be active on exact "/"
        if (linkPath === "/" && !linkHash) {
          if (pathname === "/" && !hash) {
            link.classList.add("nav-link-active");
          } else {
            link.classList.remove("nav-link-active");
          }
          return;
        }

        // CASE 2 — Hash-based links (/#services, /#pricing, etc)
        if (linkHash) {
          if (pathname === "/" && hash === linkHash) {
            link.classList.add("nav-link-active");
          } else {
            link.classList.remove("nav-link-active");
          }
          return;
        }

        // CASE 3 — Regular page links
        if (pathname === linkPath) {
          link.classList.add("nav-link-active");
        } else {
          link.classList.remove("nav-link-active");
        }
      });
    };

    window.addEventListener("load", updateActiveLinks);
    window.addEventListener("hashchange", updateActiveLinks);
  }
</script>
