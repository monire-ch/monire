---
import { getEntryCTM } from "@/lib/contentParser.astro";
import type { ContactFormConfig, Section } from "@/types";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import { markdownify } from "@/lib/utils/textConverter";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";
import SocialComponent from "@/components/social/Social.astro";
import SocialData from "@/config/social.json";
import type { InputField } from "@/types";
import config from ".astro/config.generated.json" with { type: "json" };

const {
  settings: { contactFormAction, contactFormProvider },
} = config;

type ContactItem = {
  icon: string;
  label: string;
  value?: string;
};

type ContactList = {
  enable: boolean;
  list: ContactItem[];
};

type SocialItem = {
  enable: boolean;
  label: string;
  icon: string;
  url: string;
};

type SocialConfig = {
  enable: boolean;
  title: string;
  list?: SocialItem[];
};

type pricingSectionType = Section & {
  form: ContactFormConfig;
  contactList: ContactList;
  social: SocialConfig;
};

type Props = {
  content?: pricingSectionType;
  showDetails?: boolean;
};

let defaultContent = (
  await getEntryCTM("sections", "contact-section", Astro.currentLocale)
)?.data as pricingSectionType;

let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as pricingSectionType;
const { showDetails = false } = Astro.props as Props;

let {
  enable = true,
  social,
  form,
  contactList,
} = actualContent as pricingSectionType;

const genIdFromLabel = (label: string) => label.toLowerCase().replace(" ", "-");
const socialLinks =
  social?.list?.filter((item) => item.enable) ||
  SocialData.main.filter((item) => item.enable);

const combineRadio = (list: InputField[]) => {
  const groupMap: Record<
    string,
    { index: number; groupLabel?: string; items: InputField[] }
  > = {};
  const result: any[] = [...list];

  list.forEach((item, index) => {
    if (item.group) {
      if (!groupMap[item.group]) {
        groupMap[item.group] = {
          index,
          groupLabel: item.groupLabel || "",
          items: [],
        };
      }
      groupMap[item.group].items.push(item);
    }
  });

  Object.entries(groupMap).forEach(
    ([groupName, { index, groupLabel, items }]) => {
      result[index] = { group: groupName, groupLabel, items };

      for (let i = result.length - 1; i > index; i--) {
        if (result[i].group === groupName) {
          result.splice(i, 1);
        }
      }
    },
  );

  return result;
};

form = {
  ...form,
  inputs: combineRadio(form.inputs),
};
---

{
  enable && (
    <section class="section-light relative">
      <div class="container">
        <div
          class:list={[
            "grid grid-cols-1 gap-4",
            showDetails && "lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]",
          ]}>
          {form && (
            <div
              data-aos="fade-up-sm"
              data-aos-delay="200"
              class:list={[
                "order-1 w-full lg:pb-10",
                showDetails ? "lg:max-w-[46rem]" : "",
                showDetails ? "lg:pr-10" : "lg:px-10",
              ]}>
              <form
                id="contact-form"
                {...{
                  "data-netlify":
                    contactFormProvider === "netlify" ? "true" : undefined,
                  "data-action": contactFormAction,
                  action:
                    contactFormProvider === "netlify"
                      ? contactFormAction
                      : undefined,
                  "data-provider": contactFormProvider,
                }}
                method="post"
                class:list={[
                  "grid gap-4",
                  showDetails ? "grid-cols-1 sm:grid-cols-2" : "grid-cols-1",
                ]}>
            {/* Some Hidden Inputs For provider */}
            {form.emailSubject &&
              (contactFormProvider === "formsubmit.co" ||
              contactFormProvider === "formspree" ? (
                <input
                  type="hidden"
                  name="_subject"
                  value={form.emailSubject}
                />
              ) : (
                <input type="hidden" name="subject" value={form.emailSubject} />
              ))}

            {contactFormProvider === "formsubmit.co" && (
              <input type="hidden" name="_template" value="table" />
            )}

            {form.inputs.map((input) => (
              <div
                input-wrapper
                class:list={[
                  "flex flex-col",
                  showDetails &&
                  input.tag !== "textarea" &&
                  input.type !== "checkbox" &&
                  input.type !== "radio" &&
                  !input.note
                    ? "max-sm:col-span-2"
                    : "col-span-2",
                  input.parentClass,
                ]}>
                {!input.note &&
                  input.type !== "checkbox" &&
                  input.type !== "radio" &&
                  (input.groupLabel || input.label) && (
                    <label for="name" class="form-label">
                      {input.groupLabel || input.label || "Please set label"}
                      {input.required && <span class="text-inherit">*</span>}
                    </label>
                  )}
                {input.dropdown ? (
                  <div
                    id="validation-target"
                    {...(input.required ? { "data-required": "true" } : {})}>
                    <select
                      {...(input.label ? { "data-name": input.label } : {})}
                      {...(input.id ? { id: input.id } : {})}
                      name={
                        input.name || input.label || "Please set name value"
                      }
                      {...(input.required ? { required: true } : {})}
                      data-hs-select={`{
                          ${input.dropdown.type === "search" ? `\"hasSearch\": true,` : `\"hasSearch\": false,`}
                          \n\"searchPlaceholder\": \"${input.dropdown.type === "search" ? input.dropdown.search?.placeholder || "Please set placeholder" : ""}\",\n
                          \"searchClasses\": \"form-input hs-dropdown-search-input\",
                          \n\"searchWrapperClasses\": \"hs-search-input-wrapper\",
                          \n\"placeholder\": \"${input.placeholder || "Please set placeholder"}\",
                          \n\"toggleTag\": \"<button type=\\\"button\\\" aria-expanded=\\\"false\\\"><span class=\\\"text-text-default \\\" data-title><\/span><\/button>\",
                          \n\"toggleClasses\": \"form-input hs-select-disabled:pointer-events-none hs-select-disabled:opacity-50 relative ps-4 pe-9 flex gap-x-2 text-nowrap w-full cursor-pointer border border-gray-200 text-start focus:shadow-none focus:outline-none focus:ring-1 focus:ring-primary\",\n\"dropdownClasses\": \"hs-dropdown mt-2 max-h-72 space-y-0.5 z-20 w-full border border-gray-200 overflow-hidden overflow-y-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300\",\n\"optionClasses\": \"hs-dropdown-search-item\",\n\"optionTemplate\": \"<div><div class=\\\"flex items-center\\\"><div class=\\\"text-inherit \\\" data-title><\/div><\/div><\/div>\",
                          \"optionTemplate\": \"<div class=\\\"text-inherit flex justify-between items-center w-full\\\"><span data-title><\/span><span class=\\\"hidden hs-selected:block\\\"><svg class=\\\"shrink-0 size-3.5 text-inherit \\\" xmlns=\\\"http:.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><polyline points=\\\"20 6 9 17 4 12\\\"\/><\/svg><\/span><\/div>\",
                          \"extraMarkup\": [\n      \"<div class=\\\"hidden hs-error:block absolute top-1/2 end-8 -translate-y-1/2\\\"><svg class=\\\"shrink-0 size-4 text-inherit\\\" xmlns=\\\"http:\/\/www.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><circle cx=\\\"12\\\" cy=\\\"12\\\" r=\\\"10\\\"\/><line x1=\\\"12\\\" x2=\\\"12\\\" y1=\\\"8\\\" y2=\\\"12\\\"\/><line x1=\\\"12\\\" x2=\\\"12.01\\\" y1=\\\"16\\\" y2=\\\"16\\\"\/><\/svg><\/div>\",\n      \"<div class=\\\"hidden hs-success:flex absolute inset-y-0 end-8 items-center pointer-events-none\\\"><svg class=\\\"shrink-0 size-4 text-inherit\\\" xmlns=\\\"http:\/\/www.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><polyline points=\\\"20 6 9 17 4 12\\\"\/><\/svg><\/div>\",\n      \"<div class=\\\"absolute top-1\/2 end-3 -translate-y-1\/2\\\"><svg class=\\\"shrink-0 size-3.5 text-inherit \\\" xmlns=\\\"http:\/\/www.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><path d=\\\"m7 15 5 5 5-5\\\"\/><path d=\\\"m7 9 5-5 5 5\\\"\/><\/svg><\/div>\"\n    ]
                          }`}
                      class="hidden">
                      <option value="">Choose</option>
                      {input.dropdown?.items?.map((option) => (
                        <option
                          {...(option.selected ? { selected: true } : {})}
                          value={option.value}>
                          {option.label}
                        </option>
                      ))}
                    </select>
                    <p class="hs-error:block mt-2 hidden text-sm text-red-600">
                      Please select an option.
                    </p>
                  </div>
                ) : input.tag === "textarea" ? (
                  <textarea
                    rows={input.rows || "6"}
                    name={input.name || input.label || "Please set name value"}
                    placeholder={input.placeholder || "Please set placeholder"}
                    class="form-input"
                    {...(input.required ? { required: true } : {})}
                    set:html={input.defaultValue || ""}
                  />
                ) : input.group || input.items ? (
                  <div class="form-check-wrapper">
                    {input.items?.map((input) => (
                      <div class="form-check">
                        <input
                          {...{
                            value:
                              typeof input.value === "boolean"
                                ? String(input.value)
                                : input.value || input.label,
                            checked: input.checked ? true : undefined,
                          }}
                          type={input.type || "text"}
                          name={
                            input.name ||
                            input.groupLabel ||
                            "Please set name value"
                          }
                          id={
                            input.id ||
                            genIdFromLabel(input.label || "example-id")
                          }
                          placeholder={
                            input.placeholder || "Please set placeholder"
                          }
                          class:list={[
                            input.type === "radio"
                              ? "form-radio"
                              : "form-checkbox",
                          ]}
                          {...(input.required ? { required: true } : {})}
                        />
                        <label
                          for={
                            input.id ||
                            genIdFromLabel(input.label || "example-id")
                          }
                          class="form-check-label"
                          set:html={markdownify(input.label) || "Example Label"}
                        />
                      </div>
                    ))}
                  </div>
                ) : input.type === "checkbox" || input.type === "radio" ? (
                  <div class="form-check">
                    <input
                      {...{
                        value:
                          typeof input.value === "boolean"
                            ? String(input.value)
                            : input.value || input.label,
                        checked: input.checked ? true : undefined,
                      }}
                      type={input.type || "text"}
                      name={input.name || "Please set name value"}
                      id={
                        input.id || genIdFromLabel(input.label || "example-id")
                      }
                      placeholder={
                        input.placeholder || "Please set placeholder"
                      }
                      class:list={[
                        input.type === "radio" ? "form-radio" : "form-checkbox",
                      ]}
                      {...(input.required ? { required: true } : {})}
                    />
                    <label
                      for={
                        input.id || genIdFromLabel(input.label || "example-id")
                      }
                      class="form-check-label"
                      set:html={markdownify(input.label) || "Example Label"}
                    />
                  </div>
                ) : input.note ? (
                  <div
                    {...{ "data-default": input.content }}
                    class:list={[
                      "prose-styles border p-4 text-sm",
                      input.note === "info"
                        ? "prose-p:text-slate-400 border-blue-400/25 bg-slate-600/10"
                        : input.note === "warning"
                          ? "prose-p:text-orange-400 border-amber-400/25 bg-orange-600/10"
                          : input.note === "success"
                            ? "prose-p:text-green-400 border-green-400/25 bg-green-600/10"
                            : input.note === "deprecated"
                              ? "prose-p:text-stone-400 border-green-400/25 bg-stone-600/10"
                              : input.note === "hint"
                                ? "prose-p:text-purple-400 border-purple-400/25 bg-purple-600/10"
                                : "prose-p:text-gray-400 border-gray-400/25 bg-gray-600/10",
                    ]}
                    set:html={markdownify(input.content || "", true)}
                  />
                ) : (
                  <input
                    {...(input.defaultValue
                      ? {
                          value: input.defaultValue,
                        }
                      : {})}
                    type={input.type || "text"}
                    name={input.name || input.label || "Please set name value"}
                    placeholder={input.placeholder || "Please set placeholder"}
                    class="form-input"
                    {...(input.required ? { required: true } : {})}
                  />
                )}
              </div>
            ))}

            {form.submitButton && (
              <div class="col-span-2 mt-4 flex flex-col">
                <button
                  type="submit"
                  class:list={[
                    "btn btn-md btn-primary btn-has-icon group relative inline-flex w-fit overflow-hidden",
                    "relative z-0 flex items-center gap-4",
                  ]}>
                  {form.submitButton.label}
                  <span class="flex h-6 w-12 items-center justify-center rounded-full bg-white/15">
                    <OptimizedImage
                      alt="icon"
                      class="h-5 w-5 transition-all duration-300 group-hover:rotate-180"
                      src="/images/icons/svg/star.svg"
                    />
                  </span>
                </button>
              </div>
            )}
            {form.note && (
              <div
                class="prose-a:text-primary prose-a:underline prose-a:underline-offset-2 col-span-2 flex flex-col text-sm/normal"
                set:html={markdownify(form.note, true)}
              />
            )}
              </form>
            </div>
          )}

          {showDetails && (contactList?.enable || social?.enable) && (
            <aside
              data-aos="fade-up-sm"
              data-aos-delay="250"
              class="order-2 hidden w-full lg:block lg:pt-1">
              <div class="contact-details-panel rounded-3xl border p-6 sm:p-7 lg:p-8">
                {contactList?.enable && contactList.list?.length > 0 && (
                  <div class="space-y-4">
                    {contactList.list.map((item) => (
                      <div class="contact-detail-item px-1 py-1">
                        {item.label && (
                          <p
                            class="contact-detail-label text-sm tracking-[0.04em]"
                            set:html={markdownify(item.label)}
                          />
                        )}
                      {item.value && (
                        <div
                          class="contact-detail-value prose-a:text-primary text-base leading-relaxed [&_a]:text-[var(--color-link-dark-bg)] [&_a]:no-underline [&_a]:underline-offset-2 [&_a:hover]:underline"
                          set:html={markdownify(item.value, true)}
                        />
                      )}
                    </div>
                  ))}
                </div>
                )}

                {social?.enable && socialLinks.length > 0 && (
                  <div class="contact-social-block mt-6 pt-6">
                    {social.title && (
                      <h3
                        class="contact-detail-label text-sm font-medium tracking-[0.04em]"
                        set:html={markdownify(social.title)}
                      />
                    )}
                    <SocialComponent
                      layout="classic"
                      linkType="follow"
                      size="sm"
                      class="contact-details-social mt-4 gap-3"
                      list={socialLinks}
                    />
                  </div>
                )}
              </div>
            </aside>
          )}
        </div>
      </div>
    </section>
  )
}

<style>
  .contact-details-panel {
    border-color: color-mix(
      in srgb,
      var(--color-border-surface-dark) 72%,
      transparent
    );
    background: linear-gradient(
      145deg,
      color-mix(in srgb, var(--color-bg-dark) 80%, var(--color-monire-deep-teal))
        0%,
      color-mix(in srgb, var(--color-bg-dark) 88%, var(--color-monire-deep-teal))
        100%
    );
    box-shadow: none;
  }

  .contact-detail-item {
    border: 0;
    background: transparent;
  }

  .contact-detail-label {
    color: color-mix(in srgb, white 74%, transparent);
  }

  .contact-detail-value {
    margin-top: 0.25rem;
    color: color-mix(in srgb, white 94%, transparent);
  }

  .contact-detail-value :global(p),
  .contact-detail-value :global(span),
  .contact-detail-value :global(strong) {
    color: inherit;
  }

  .contact-detail-value :global(p) {
    margin: 0;
  }

  .contact-detail-value :global(a),
  .contact-details-panel :global(a) {
    color: var(--color-link-dark-bg) !important;
    text-decoration-thickness: var(--color-link-underline-thickness);
    text-underline-offset: 0.15em;
  }

  .contact-detail-value :global(a:hover),
  .contact-details-panel :global(a:hover) {
    color: var(--color-link-dark-bg-hover) !important;
  }

  .contact-social-block {
    border-top: 1px solid color-mix(in srgb, white 14%, transparent);
  }

  .contact-details-social :global(a) {
    color: var(--color-link-dark-bg);
    background: transparent;
    border: 1px solid
      color-mix(in srgb, var(--color-link-dark-bg) 55%, transparent);
  }

  .contact-details-social :global(a:hover) {
    color: var(--color-link-dark-bg-hover);
    border-color: color-mix(
      in srgb,
      var(--color-link-dark-bg-hover) 72%,
      transparent
    );
    background: transparent;
  }

  @media (max-width: 1023px) {
    .contact-details-panel {
      border: 0;
      background: transparent;
      box-shadow: none;
      padding: 0;
      border-radius: 0;
    }

    .contact-social-block {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top-color: color-mix(in srgb, white 10%, transparent);
    }
  }
</style>

<script>
  import "@preline/select";
  import {
    formspreeSubmit,
    netlifySubmit,
    formSubmit,
    setMessage,
  } from "@/lib/utils/FormHandle";
  import contact from "@/config/contact.json" with { type: "json" };

  document.addEventListener("DOMContentLoaded", () => {
    const form = document.getElementById(
      "contact-form",
    ) as HTMLFormElement | null;

    if (!form) return;

    const selectTags = form.querySelectorAll(
      "select[data-hs-select]",
    ) as NodeListOf<HTMLSelectElement>;

    selectTags.forEach((select) => {
      if (select.hasAttribute("required")) {
        select.setAttribute("data-required", "true");
        select.removeAttribute("required");
      }
    });

    const validatePrelineSelect = (select: HTMLSelectElement): boolean => {
      const isRequired = select.getAttribute("data-required") === "true";
      const value = select.value;
      const isEmpty = !value || value === "" || value === "Choose";

      let wrapper = select.parentElement;
      while (wrapper && wrapper.tagName !== "FORM") {
        if (wrapper.id === "validation-target") {
          break;
        }
        wrapper = wrapper.parentElement;
      }

      if (!wrapper) return true;

      const errorMsg = wrapper.querySelector("p.text-red-600");
      const successMsg = wrapper.querySelector("p.text-white");

      if (isRequired && isEmpty) {
        wrapper.classList.add("hs-error");
        wrapper.classList.remove("hs-success");

        if (errorMsg) {
          errorMsg.classList.remove("hidden");
        }
        if (successMsg) {
          successMsg.classList.add("hidden");
        }

        return false;
      } else {
        wrapper.classList.remove("hs-error");

        if (errorMsg) {
          errorMsg.classList.add("hidden");
        }

        if (!isEmpty) {
          wrapper.classList.add("hs-success");
          if (successMsg) {
            successMsg.classList.remove("hidden");
          }
        } else {
          wrapper.classList.remove("hs-success");
          if (successMsg) {
            successMsg.classList.add("hidden");
          }
        }

        return true;
      }
    };

    selectTags.forEach((select) => {
      select.addEventListener("change", () => {
        validatePrelineSelect(select);
      });
    });

    form.addEventListener("submit", async (e: Event) => {
      e.preventDefault();

      const provider = form.getAttribute("data-provider") || "";
      const action = form.getAttribute("data-action") || "";

      let allSelectsValid = true;
      selectTags.forEach((select) => {
        const isValid = validatePrelineSelect(select);
        if (!isValid) {
          allSelectsValid = false;
        }
      });

      if (!allSelectsValid) {
        const firstInvalid = Array.from(selectTags).find(
          (select) => !validatePrelineSelect(select),
        );
        if (firstInvalid) {
          let wrapper = firstInvalid.parentElement;
          while (wrapper && wrapper.tagName !== "FORM") {
            if (wrapper.id === "validation-target") {
              wrapper.scrollIntoView({ behavior: "smooth", block: "center" });
              break;
            }
            wrapper = wrapper.parentElement;
          }
        }
        return;
      }

      if (!form.checkValidity()) {
        form.reportValidity();
        return;
      }

      setMessage("Form Submitting!...", true, true, form);

      try {
        switch (provider) {
          case "netlify":
            await netlifySubmit(form, action);
            break;
          case "formsubmit.co":
            await formSubmit({
              form,
              action,
            });
            break;
          case "formspree":
            await formspreeSubmit(
              Object.fromEntries(new FormData(form).entries()),
              5000,
              form,
            );
            break;
          default:
            throw new Error("Unknown form provider.");
        }
      } catch (error) {
        setMessage(
          error +
            `! Please contact us for assitance at [${contact.email}](mailto:${contact.email})`,
          false,
          false,
          form,
        );
      }
    });
  });
</script>
