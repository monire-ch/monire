---
import { getEntryCTM } from "@/lib/contentParser.astro";
import type { ContactFormConfig, Section } from "@/types";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import { markdownify } from "@/lib/utils/textConverter";
import SocialComponent from "@/components/social/Social.astro";
import SocialData from "@/config/social.json";
import type { InputField } from "@/types";
import config from ".astro/config.generated.json" with { type: "json" };
import Button from "@/layouts/components/buttons/Button.astro";
import Link from "@/layouts/components/links/Link.astro";

const {
  settings: { contactFormAction, contactFormProvider },
} = config;

type ContactItem = {
  icon: string;
  label: string;
  value?: string;
};

type ContactList = {
  enable: boolean;
  list: ContactItem[];
};

type SocialItem = {
  enable: boolean;
  label: string;
  icon: string;
  url: string;
};

type SocialConfig = {
  enable: boolean;
  title: string;
  list?: SocialItem[];
};

type pricingSectionType = Section & {
  form: ContactFormConfig;
  contactList: ContactList;
  social: SocialConfig;
};

type Props = {
  content?: pricingSectionType;
  showDetails?: boolean;
};

let defaultContent = (
  await getEntryCTM("sections", "contact-section", Astro.currentLocale)
)?.data as pricingSectionType;

let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as pricingSectionType;
const { showDetails = false } = Astro.props as Props;

let {
  enable = true,
  social,
  form,
  contactList,
} = actualContent as pricingSectionType;

const genIdFromLabel = (label: string) => label.toLowerCase().replace(" ", "-");
const socialLinks =
  social?.list?.filter((item) => item.enable) ||
  SocialData.main.filter((item) => item.enable);

const combineRadio = (list: InputField[]) => {
  const groupMap: Record<
    string,
    { index: number; groupLabel?: string; items: InputField[] }
  > = {};
  const result: any[] = [...list];

  list.forEach((item, index) => {
    if (item.group) {
      if (!groupMap[item.group]) {
        groupMap[item.group] = {
          index,
          groupLabel: item.groupLabel || "",
          items: [],
        };
      }
      groupMap[item.group].items.push(item);
    }
  });

  Object.entries(groupMap).forEach(
    ([groupName, { index, groupLabel, items }]) => {
      result[index] = { group: groupName, groupLabel, items };

      for (let i = result.length - 1; i > index; i--) {
        if (result[i].group === groupName) {
          result.splice(i, 1);
        }
      }
    },
  );

  return result;
};

const parseMarkdownLink = (value?: string) => {
  if (!value) return null;
  const match = value.match(/^\s*\[([^\]]+)\]\(([^)]+)\)\s*$/);
  if (!match) return null;
  return { label: match[1], href: match[2] };
};

form = {
  ...form,
  inputs: combineRadio(form.inputs),
};

const validationMessages = {
  requiredSelect:
    form.validationMessages?.requiredSelect || "Please select an option.",
  invalidEmail:
    form.validationMessages?.invalidEmail ||
    "Please enter a valid email address.",
  submitting: form.validationMessages?.submitting || "Form Submitting!...",
  assistanceAt:
    form.validationMessages?.assistanceAt ||
    "Please contact us for assistance at",
};
---

{
  enable && (
    <section class="section-light relative">
      <div class="container">
        <div
          class:list={[
            "grid grid-cols-1 gap-4",
            showDetails && "lg:grid-cols-[minmax(0,2fr)_minmax(0,1fr)]",
          ]}>
          {form && (
            <div
              data-aos="fade-up-sm"
              data-aos-delay="200"
              class:list={[
                "order-1 w-full lg:pb-10",
                showDetails ? "lg:max-w-[46rem]" : "",
                showDetails ? "lg:pr-10" : "lg:px-10",
              ]}>
              <form
              id="contact-form"
                class="contact-form"
                novalidate
                {...{
                  "data-netlify":
                    contactFormProvider === "netlify" ? "true" : undefined,
                  "data-action": contactFormAction,
                  "data-msg-required-select": validationMessages.requiredSelect,
                  "data-msg-invalid-email": validationMessages.invalidEmail,
                  "data-msg-submitting": validationMessages.submitting,
                  "data-msg-assistance-at": validationMessages.assistanceAt,
                  action:
                    contactFormProvider === "netlify"
                      ? contactFormAction
                      : undefined,
                  "data-provider": contactFormProvider,
                }}
                method="post"
                class:list={[
                  "grid gap-4",
                  showDetails ? "grid-cols-1 sm:grid-cols-2" : "grid-cols-1",
                ]}>
            {/* Some Hidden Inputs For provider */}
            {form.emailSubject &&
              (contactFormProvider === "formsubmit.co" ||
              contactFormProvider === "formspree" ? (
                <input
                  type="hidden"
                  name="_subject"
                  value={form.emailSubject}
                />
              ) : (
                <input type="hidden" name="subject" value={form.emailSubject} />
              ))}

            {contactFormProvider === "formsubmit.co" && (
              <input type="hidden" name="_template" value="table" />
            )}

            {form.inputs.map((input) => (
              <div
                input-wrapper
                class:list={[
                  "flex flex-col",
                  showDetails &&
                  input.tag !== "textarea" &&
                  input.type !== "checkbox" &&
                  input.type !== "radio" &&
                  !input.note
                    ? "max-sm:col-span-2"
                    : "col-span-2",
                  input.parentClass,
                ]}>
                {!input.note &&
                  input.type !== "checkbox" &&
                  input.type !== "radio" &&
                  (input.groupLabel || input.label) && (
                    <label for="name" class="form-label">
                      {input.groupLabel || input.label || "Please set label"}
                      {input.required && <span class="text-inherit">*</span>}
                    </label>
                  )}
                {input.dropdown ? (
                  <div
                    id="validation-target"
                    {...(input.required ? { "data-required": "true" } : {})}>
                    <select
                      {...(input.label ? { "data-name": input.label } : {})}
                      {...(input.id ? { id: input.id } : {})}
                      data-required={input.required ? "true" : "false"}
                      name={
                        input.name || input.label || "Please set name value"
                      }
                      {...(input.dropdown?.multiple ? { multiple: true } : {})}
                      {...(input.required ? { required: true } : {})}
                      data-hs-select={`{
                          ${input.dropdown.type === "search" ? `\"hasSearch\": true,` : `\"hasSearch\": false,`}
                          \n\"searchPlaceholder\": \"${input.dropdown.type === "search" ? input.dropdown.search?.placeholder || "Please set placeholder" : ""}\",\n
                          \"searchClasses\": \"form-input hs-dropdown-search-input\",
                          \n\"searchWrapperClasses\": \"hs-search-input-wrapper\",
                          \n\"placeholder\": \"${input.placeholder || "Please set placeholder"}\",
                          \n\"dropdownAutoPlacement\": true,
                          ${
                            input.dropdown?.multiple
                              ? `\n\"toggleTag\": \"<button type=\\\"button\\\" aria-expanded=\\\"false\\\"><span class=\\\"text-text-default\\\"><\/span><\/button>\",`
                              : `\n\"toggleTag\": \"<button type=\\\"button\\\" aria-expanded=\\\"false\\\"><span class=\\\"text-text-default\\\" data-title><\/span><\/button>\",`
                          }
                          \n\"toggleClasses\": \"form-input hs-select-disabled:pointer-events-none hs-select-disabled:opacity-50 relative ps-4 pe-9 flex gap-x-2 text-nowrap w-full cursor-pointer border border-gray-200 text-start focus:shadow-none focus:outline-none focus:ring-1 focus:ring-primary\",\n\"dropdownClasses\": \"hs-dropdown mt-2 max-h-72 space-y-0.5 z-20 w-full border border-gray-200 overflow-hidden overflow-y-auto [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-track]:bg-gray-100 [&::-webkit-scrollbar-thumb]:bg-gray-300\",\n\"optionClasses\": \"hs-dropdown-search-item\",\n\"optionTemplate\": \"<div><div class=\\\"flex items-center\\\"><div class=\\\"text-inherit \\\" data-title><\/div><\/div><\/div>\",
                          \"optionTemplate\": \"<div class=\\\"text-inherit flex justify-between items-center w-full\\\"><span data-title><\/span><span class=\\\"hidden hs-selected:block\\\"><svg class=\\\"shrink-0 size-3.5 text-inherit \\\" xmlns=\\\"http:.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><polyline points=\\\"20 6 9 17 4 12\\\"\/><\/svg><\/span><\/div>\",
                          \"extraMarkup\": [\n      \"<div class=\\\"hidden hs-error:block absolute top-1/2 end-8 -translate-y-1/2\\\"><svg class=\\\"shrink-0 size-4 text-inherit\\\" xmlns=\\\"http:\/\/www.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><circle cx=\\\"12\\\" cy=\\\"12\\\" r=\\\"10\\\"\/><line x1=\\\"12\\\" x2=\\\"12\\\" y1=\\\"8\\\" y2=\\\"12\\\"\/><line x1=\\\"12\\\" x2=\\\"12.01\\\" y1=\\\"16\\\" y2=\\\"16\\\"\/><\/svg><\/div>\",\n      \"<div class=\\\"hidden hs-success:flex absolute inset-y-0 end-8 items-center pointer-events-none\\\"><svg class=\\\"shrink-0 size-4 text-inherit\\\" xmlns=\\\"http:\/\/www.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><polyline points=\\\"20 6 9 17 4 12\\\"\/><\/svg><\/div>\",\n      \"<div class=\\\"absolute top-1\/2 end-3 -translate-y-1\/2\\\"><svg class=\\\"shrink-0 size-3.5 text-inherit \\\" xmlns=\\\"http:\/\/www.w3.org\/2000\/svg\\\" width=\\\"24\\\" height=\\\"24\\\" viewBox=\\\"0 0 24 24\\\" fill=\\\"none\\\" stroke=\\\"currentColor\\\" stroke-width=\\\"2\\\" stroke-linecap=\\\"round\\\" stroke-linejoin=\\\"round\\\"><path d=\\\"m7 15 5 5 5-5\\\"\/><path d=\\\"m7 9 5-5 5 5\\\"\/><\/svg><\/div>\"\n    ]
                          }`}
                      class="hidden">
                      <option value="">Choose</option>
                      {input.dropdown?.items?.map((option) => (
                        <option
                          {...(option.selected ? { selected: true } : {})}
                          value={option.value}>
                          {option.label}
                        </option>
                      ))}
                    </select>
                    <p class="hs-error:block mt-2 hidden text-sm text-red-600">
                      {validationMessages.requiredSelect}
                    </p>
                  </div>
                ) : input.tag === "textarea" ? (
                  <textarea
                    rows={input.rows || "6"}
                    name={input.name || input.label || "Please set name value"}
                    placeholder={input.placeholder || "Please set placeholder"}
                    class="form-input"
                    {...(input.required ? { required: true } : {})}
                    set:html={input.defaultValue || ""}
                  />
                ) : input.group || input.items ? (
                  <div class="form-check-wrapper">
                    {input.items?.map((input) => (
                      <div class="form-check">
                        <input
                          {...{
                            value:
                              typeof input.value === "boolean"
                                ? String(input.value)
                                : input.value || input.label,
                            checked: input.checked ? true : undefined,
                          }}
                          type={input.type || "text"}
                          name={
                            input.name ||
                            input.groupLabel ||
                            "Please set name value"
                          }
                          id={
                            input.id ||
                            genIdFromLabel(input.label || "example-id")
                          }
                          placeholder={
                            input.placeholder || "Please set placeholder"
                          }
                          class:list={[
                            input.type === "radio"
                              ? "form-radio"
                              : "form-checkbox",
                          ]}
                          {...(input.required ? { required: true } : {})}
                        />
                        <label
                          for={
                            input.id ||
                            genIdFromLabel(input.label || "example-id")
                          }
                          class="form-check-label"
                          set:html={markdownify(input.label) || "Example Label"}
                        />
                      </div>
                    ))}
                  </div>
                ) : input.type === "checkbox" || input.type === "radio" ? (
                  <div class="form-check">
                    <input
                      {...{
                        value:
                          typeof input.value === "boolean"
                            ? String(input.value)
                            : input.value || input.label,
                        checked: input.checked ? true : undefined,
                      }}
                      type={input.type || "text"}
                      name={input.name || "Please set name value"}
                      id={
                        input.id || genIdFromLabel(input.label || "example-id")
                      }
                      placeholder={
                        input.placeholder || "Please set placeholder"
                      }
                      class:list={[
                        input.type === "radio" ? "form-radio" : "form-checkbox",
                      ]}
                      {...(input.required ? { required: true } : {})}
                    />
                    <label
                      for={
                        input.id || genIdFromLabel(input.label || "example-id")
                      }
                      class="form-check-label"
                      set:html={markdownify(input.label) || "Example Label"}
                    />
                  </div>
                ) : input.note ? (
                  <div
                    {...{ "data-default": input.content }}
                    class:list={[
                      "prose-styles form-status-message border p-4 text-sm",
                      input.note === "success"
                        ? "form-status-success"
                        : input.note === "warning"
                          ? "form-status-error"
                          : input.note === "info"
                            ? "form-status-info"
                            : input.note === "hint"
                              ? "form-status-hint"
                              : input.note === "deprecated"
                                ? "form-status-deprecated"
                                : "",
                    ]}
                    set:html={markdownify(input.content || "", true)}
                  />
                ) : (
                  <input
                    {...(input.defaultValue
                      ? {
                          value: input.defaultValue,
                        }
                      : {})}
                    type={input.type || "text"}
                    name={input.name || input.label || "Please set name value"}
                    placeholder={input.placeholder || "Please set placeholder"}
                    class="form-input"
                    {...(input.type === "email"
                      ? {
                          inputmode: "email",
                          autocomplete: "email",
                        }
                      : {})}
                    {...(input.required ? { required: true } : {})}
                  />
                )}
              </div>
            ))}

            {form.submitButton && (
              <div class="col-span-2 mt-4 flex flex-col">
                <Button
                  tag="button"
                  type="submit"
                  content={{
                    enable: true,
                    label: form.submitButton.label,
                  }}
                  variant="primary"
                  class="w-fit"
                />
              </div>
            )}
            {form.note && (
              <div
                class="prose-a:text-primary prose-a:underline prose-a:underline-offset-2 col-span-2 flex flex-col text-sm/normal"
                set:html={markdownify(form.note, true)}
              />
            )}
              </form>
            </div>
          )}

          {showDetails && (contactList?.enable || social?.enable) && (
            <aside
              data-aos="fade-up-sm"
              data-aos-delay="250"
              class="order-2 hidden w-full lg:block lg:pt-1">
              <div class="contact-details-panel rounded-3xl border p-6 sm:p-7 lg:p-8">
                {contactList?.enable && contactList.list?.length > 0 && (
                  <div class="space-y-4">
                    {contactList.list.map((item) => (
                      <div class="contact-detail-item px-1 py-1">
                        {item.label && (
                          <p
                            class="contact-detail-label text-sm tracking-[0.04em]"
                            set:html={markdownify(item.label)}
                          />
                        )}
                      {item.value &&
                        (() => {
                          const parsedLink = parseMarkdownLink(item.value);
                          return parsedLink ? (
                            <div class="contact-detail-value text-base leading-relaxed">
                              <Link href={parsedLink.href}>
                                {parsedLink.label}
                              </Link>
                            </div>
                          ) : (
                            <p class="contact-detail-value text-base leading-relaxed">
                              {item.value}
                            </p>
                          );
                        })()}
                    </div>
                  ))}
                </div>
                )}

                {social?.enable && socialLinks.length > 0 && (
                  <div class="contact-social-block mt-6 pt-6">
                    {social.title && (
                      <h3
                        class="contact-detail-label text-sm font-medium tracking-[0.04em]"
                        set:html={markdownify(social.title)}
                      />
                    )}
                    <SocialComponent
                      layout="classic"
                      linkType="follow"
                      size="sm"
                      class="contact-details-social mt-4 gap-3"
                      list={socialLinks}
                    />
                  </div>
                )}
              </div>
            </aside>
          )}
        </div>
      </div>
    </section>
  )
}

<style>
  .contact-form .form-status-message {
    border-radius: 1rem;
    border-color: color-mix(
      in srgb,
      var(--color-border-surface-dark) 70%,
      transparent
    );
    background: color-mix(in srgb, var(--color-bg-dark) 76%, transparent);
    color: color-mix(in srgb, white 88%, transparent);
  }

  .contact-form .form-status-message :global(p) {
    margin: 0;
    color: inherit;
  }

  .contact-form .form-status-message :global(strong) {
    color: inherit;
  }

  .contact-form .form-status-message :global(a) {
    color: var(--color-link-dark-bg) !important;
    text-decoration-thickness: var(--color-link-underline-thickness);
    text-underline-offset: 0.15em;
  }

  .contact-form .form-status-message :global(a:hover) {
    color: var(--color-link-dark-bg-hover) !important;
  }

  .contact-form .form-status-success {
    border-color: color-mix(in srgb, var(--color-link-dark-bg) 45%, transparent);
    background: var(--color-bg-page);
    color: var(--color-monire-deep-teal);
  }

  .contact-form .form-status-error {
    border-width: 2px;
    border-color: color-mix(in srgb, var(--color-mustard) 88%, white);
    background: linear-gradient(
      135deg,
      color-mix(in srgb, var(--color-mustard-30) 42%, transparent) 0%,
      color-mix(in srgb, var(--color-mustard) 18%, transparent) 100%
    );
    color: white;
    box-shadow:
      0 0 0 1px color-mix(in srgb, var(--color-mustard) 30%, transparent),
      0 0.5rem 1.25rem color-mix(in srgb, black 30%, transparent);
  }

  .contact-form .form-status-error :global(p)::before {
    content: "!";
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.2rem;
    height: 1.2rem;
    margin-right: 0.5rem;
    border-radius: 9999px;
    font-weight: 700;
    line-height: 1;
    color: color-mix(in srgb, var(--color-bg-dark) 92%, black);
    background: color-mix(in srgb, var(--color-mustard) 92%, white);
    box-shadow: 0 0 0 1px color-mix(in srgb, black 24%, transparent);
    vertical-align: text-bottom;
  }

  .contact-form .form-status-info {
    border-color: color-mix(in srgb, var(--color-link-dark-bg) 35%, transparent);
    background: color-mix(in srgb, var(--color-bg-dark) 82%, transparent);
    color: color-mix(in srgb, white 90%, transparent);
  }

  .contact-form .form-status-hint {
    border-color: color-mix(
      in srgb,
      var(--color-border-surface-dark) 82%,
      transparent
    );
    background: color-mix(in srgb, var(--color-bg-dark) 80%, transparent);
    color: color-mix(in srgb, white 88%, transparent);
  }

  .contact-form .form-status-deprecated {
    border-color: color-mix(
      in srgb,
      var(--color-border-surface-dark) 72%,
      transparent
    );
    background: color-mix(in srgb, var(--color-bg-dark) 86%, transparent);
    color: color-mix(in srgb, white 76%, transparent);
  }

  .contact-form.is-submitting .message.success .form-status-message {
    border-color: color-mix(in srgb, var(--color-link-dark-bg) 58%, transparent);
    background: var(--color-bg-page);
    color: var(--color-monire-deep-teal);
  }

  .contact-form.is-submitting .message.success .form-status-message :global(p) {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .contact-form.is-submitting .message.success .form-status-message :global(p)::before {
    content: "";
    width: 0.85rem;
    height: 0.85rem;
    border-radius: 9999px;
    border: 2px solid color-mix(in srgb, white 34%, transparent);
    border-top-color: color-mix(in srgb, white 92%, transparent);
    animation: contact-form-spin 0.8s linear infinite;
    flex-shrink: 0;
  }

  @keyframes contact-form-spin {
    to {
      transform: rotate(360deg);
    }
  }

  .contact-details-panel {
    border-color: color-mix(
      in srgb,
      var(--color-border-surface-dark) 72%,
      transparent
    );
    background: linear-gradient(
      145deg,
      color-mix(in srgb, var(--color-bg-dark) 80%, var(--color-monire-deep-teal))
        0%,
      color-mix(in srgb, var(--color-bg-dark) 88%, var(--color-monire-deep-teal))
        100%
    );
    box-shadow: none;
  }

  .contact-detail-item {
    border: 0;
    background: transparent;
  }

  .contact-detail-label {
    color: color-mix(in srgb, white 74%, transparent);
  }

  .contact-detail-value {
    margin-top: 0.25rem;
    color: color-mix(in srgb, white 94%, transparent);
  }

  .contact-detail-value :global(p),
  .contact-detail-value :global(span),
  .contact-detail-value :global(strong) {
    color: inherit;
  }

  .contact-detail-value :global(p) {
    margin: 0;
  }

  .contact-detail-value :global(a),
  .contact-details-panel :global(a) {
    color: var(--color-link-dark-bg) !important;
    text-decoration: underline;
    text-decoration-thickness: var(--color-link-underline-thickness);
    text-underline-offset: 0.15em;
  }

  .contact-detail-value :global(a:hover),
  .contact-details-panel :global(a:hover) {
    color: var(--color-link-dark-bg-hover) !important;
  }

  .contact-social-block {
    border-top: 1px solid color-mix(in srgb, white 14%, transparent);
  }

  .contact-details-social :global(a) {
    color: var(--color-link-dark-bg);
    background: transparent;
    border: 1px solid
      color-mix(in srgb, var(--color-link-dark-bg) 55%, transparent);
  }

  .contact-details-social :global(a:hover) {
    color: var(--color-link-dark-bg-hover);
    border-color: color-mix(
      in srgb,
      var(--color-link-dark-bg-hover) 72%,
      transparent
    );
    background: transparent;
  }

  @media (max-width: 1023px) {
    .contact-details-panel {
      border: 0;
      background: transparent;
      box-shadow: none;
      padding: 0;
      border-radius: 0;
    }

    .contact-social-block {
      margin-top: 1.5rem;
      padding-top: 1.5rem;
      border-top-color: color-mix(in srgb, white 10%, transparent);
    }
  }
</style>

<script>
  import "@preline/select";
  import {
    formspreeSubmit,
    netlifySubmit,
    formSubmit,
    setMessage,
  } from "@/lib/utils/FormHandle";
  import contact from "@/config/contact.json" with { type: "json" };

  document.addEventListener("DOMContentLoaded", () => {
    const forms = document.querySelectorAll(
      "form.contact-form",
    ) as NodeListOf<HTMLFormElement>;
    if (!forms.length) return;

    const initForm = (form: HTMLFormElement) => {
      const selectTags = form.querySelectorAll(
        "select[data-hs-select]",
      ) as NodeListOf<HTMLSelectElement>;
      const emailInput = form.querySelector(
        'input[type="email"]',
      ) as HTMLInputElement | null;
      const validationMessages = {
        requiredSelect:
          form.dataset.msgRequiredSelect || "Please select an option.",
        invalidEmail:
          form.dataset.msgInvalidEmail || "Please enter a valid email address.",
        submitting: form.dataset.msgSubmitting || "Form Submitting!...",
        assistanceAt:
          form.dataset.msgAssistanceAt ||
          "Please contact us for assistance at",
      };

      selectTags.forEach((select) => {
        if (select.hasAttribute("required")) {
          select.removeAttribute("required");
        }
      });

      const validatePrelineSelect = (select: HTMLSelectElement): boolean => {
        const isRequired = select.getAttribute("data-required") === "true";
        const formData = new FormData(form);
        const selectedValues = formData
          .getAll(select.name)
          .map((value) => String(value));
        const hasValidValue = selectedValues.some(
          (value) => value && value !== "Choose",
        );
        const isEmpty = selectedValues.length === 0 || !hasValidValue;

        const wrapper = select.closest("#validation-target");
        if (!wrapper) return true;

        const errorMsg = wrapper.querySelector("p.text-red-600");
        const successMsg = wrapper.querySelector("p.text-white");

        if (isRequired && isEmpty) {
          wrapper.classList.add("hs-error");
          wrapper.classList.remove("hs-success");
          errorMsg?.classList.remove("hidden");
          successMsg?.classList.add("hidden");
          return false;
        }

        wrapper.classList.remove("hs-error");
        errorMsg?.classList.add("hidden");
        if (!isEmpty) {
          wrapper.classList.add("hs-success");
          successMsg?.classList.remove("hidden");
        } else {
          wrapper.classList.remove("hs-success");
          successMsg?.classList.add("hidden");
        }
        return true;
      };

      selectTags.forEach((select) => {
        select.addEventListener("change", () => {
          validatePrelineSelect(select);
        });
      });

      const isValidEmailFormat = (value: string): boolean =>
        /^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/.test(value.trim());

      const validateEmail = (): boolean => {
        if (!emailInput) return true;
        const value = emailInput.value.trim();

        if (!value) {
          emailInput.setCustomValidity("");
          return true;
        }

        if (!isValidEmailFormat(value)) {
          emailInput.setCustomValidity(validationMessages.invalidEmail);
          return false;
        }

        emailInput.setCustomValidity("");
        return true;
      };

      emailInput?.addEventListener("input", validateEmail);
      emailInput?.addEventListener("blur", validateEmail);

      const focusInvalidSelect = (select: HTMLSelectElement) => {
        const wrapper = select.closest("#validation-target");
        const toggle = wrapper?.querySelector(
          'button[aria-expanded]',
        ) as HTMLButtonElement | null;
        toggle?.focus();
      };

      const showFormMessage = (
        message: string,
        success: boolean,
        disableSubmit = false,
      ) => {
        setMessage(message, success, disableSubmit, form);
      };

      form.addEventListener("submit", async (e: Event) => {
        e.preventDefault();

        const provider = form.getAttribute("data-provider") || "";
        const action = form.getAttribute("data-action") || "";

        const orderedFields = Array.from(form.elements).filter((el) => {
          const field = el as
            | HTMLInputElement
            | HTMLTextAreaElement
            | HTMLSelectElement;
          if (!field.name || field.hasAttribute("disabled")) return false;
          if ("type" in field) {
            const inputType = (field as HTMLInputElement).type;
            if (
              inputType === "hidden" ||
              inputType === "submit" ||
              inputType === "button" ||
              inputType === "reset"
            ) {
              return false;
            }
          }
          return true;
        }) as Array<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>;

        for (const field of orderedFields) {
          if (
            field instanceof HTMLInputElement &&
            (field.type === "radio" || field.type === "checkbox")
          ) {
            if (!field.checkValidity()) {
              field.reportValidity();
              field.focus();
              return;
            }
            continue;
          }

          if (field instanceof HTMLSelectElement && field.matches("[data-hs-select]")) {
            if (!validatePrelineSelect(field)) {
              focusInvalidSelect(field);
              return;
            }
            continue;
          }

          if (field === emailInput && !validateEmail()) {
            emailInput.reportValidity();
            emailInput.focus();
            return;
          }

          if (!field.checkValidity()) {
            field.reportValidity();
            field.focus();
            return;
          }
        }

        showFormMessage(validationMessages.submitting, true, true);

        try {
          switch (provider) {
            case "netlify":
              await netlifySubmit(form, action);
              break;
            case "formsubmit.co":
              await formSubmit({
                form,
                action,
              });
              break;
            case "formspree":
              await formspreeSubmit(
                Object.fromEntries(new FormData(form).entries()),
                5000,
                form,
              );
              break;
            default:
              throw new Error("Unknown form provider.");
          }
        } catch (error) {
          showFormMessage(
            `${error}! ${validationMessages.assistanceAt} [${contact.email}](mailto:${contact.email})`,
            false,
            false,
          );
        }
      });
    };

    forms.forEach((form) => {
      try {
        initForm(form);
      } catch (error) {
        console.error("Failed to initialize contact form", error);
      }
    });
  });
</script>
