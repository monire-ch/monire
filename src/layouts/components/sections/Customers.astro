---
import Marquee from "@/components/widgets/Marquee.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import OptimizedImage from "@/components/utilities/OptimizedImage.astro";
import type { customersSectionType } from "@/types";
import { markdownify } from "@/lib/utils/textConverter";

type Props = {
  content?: customersSectionType;
  class?: string;
  width?: "sm" | "md";
};

// Fetching the default content for the this section
let defaultContent = (
  await getEntryCTM("sections", "customers", Astro.currentLocale)
)?.data as customersSectionType;

// Enables content customization (e.g., title, description) with a fallback to 'defaultContent' if not provided.
// The 'content' prop should match the structure of 'defaultContent'.
// Allows using this section with different content across multiple pages.
// If 'content' is missing, 'defaultContent' will be used.
let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as customersSectionType;

// Extracting required values from 'content' object
let {
  enable = true,
  description,
  marquee,
  list,
} = actualContent as customersSectionType;

const { class: className, width = "sm", ...rest } = Astro.props;

let duplicatedList = list;

// If list length is less then 3 then duplicate the list at at least 3 times
if (list.length <= 3) {
  Array.from({ length: 3 }, () => [...list]).flat();
} else if (list.length > 3) {
  Array.from({ length: 2 }, () => [...list]).flat();
}
---

{
  enable && (
    <section class:list={[className]} {...rest}>
      <div class="container">
        <div
          class:list={[
            "mx-auto text-center",
            width === "sm" ? "max-w-screen-sm" : "max-w-3xl",
          ]}>
          {description && (
            <p
              class="shrink-0 text-center text-xs tracking-wider opacity-80"
              set:html={markdownify(description)}
            />
          )}
          <div class="relative mt-4 flex items-center overflow-hidden mask-[linear-gradient(to_right,rgba(0,0,0,0)_0%,rgb(0,0,0)_10%,rgb(0,0,0)_90%,rgba(0,0,0,0)_100%)]">
            <Marquee
              marqueeElements={duplicatedList.length}
              marqueePauseOnHover={marquee.pauseOnHover}
              marqueeReverse={marquee.reverse}
              marqueeDuration={marquee.duration}
              marqueeElementWidth={marquee.elementWidth}
              marqueeElementWidthAuto={marquee.elementWidthAuto}
              marqueeElementWidthResponsive={
                marquee.elementWidthInSmallDevices
              }>
              {duplicatedList.map((item) => (
                <div
                  class:list={[
                    "px-4",
                    {
                      "min-w-(--marquee-element-width-responsive) md:min-w-(--marquee-element-width)":
                        !marquee.elementWidthAuto,
                    },
                    {
                      "min-w-fit": marquee.elementWidthAuto,
                    },
                  ]}>
                  <OptimizedImage
                    src={item.src}
                    alt={item.alt}
                    class="h-8 min-h-8 min-w-fit"
                  />
                </div>
              ))}
              {duplicatedList.map((item) => (
                <div
                  class:list={[
                    "px-4",
                    {
                      "min-w-(--marquee-element-width-responsive) md:min-w-(--marquee-element-width)":
                        !marquee.elementWidthAuto,
                    },
                    {
                      "min-w-fit": marquee.elementWidthAuto,
                    },
                  ]}>
                  <OptimizedImage
                    src={item.src}
                    alt={item.alt}
                    class="h-8 min-h-8 min-w-fit"
                  />
                </div>
              ))}
            </Marquee>
          </div>
        </div>
      </div>
    </section>
  )
}
