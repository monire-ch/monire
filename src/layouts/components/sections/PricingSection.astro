---
import { markdownify } from "@/lib/utils/textConverter";
import overrideObjects from "@/lib/utils/overrideObjects";
import Button from "@/layouts/components/buttons/Button.astro";
import PricingCard from "@/layouts/components/cards/PricingCard.astro";
import Subtitle from "@/layouts/components/widgets/Subtitle.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";
import type { 
  Button as ButtonData,
  PricingPlans,
  PricingTier,
  Section,
 } from "@/types";

type PricingTabItem = {
  label: string;
  selected: boolean;
};

type AiAutomationsContent = {
  title: string;
  subtitle: string;
  ctas: Pick<ButtonData, "label" | "url" | "variant">[];
};

type PricingSectionContent = Section & {
  plans: PricingPlans;
  list: PricingTier[];
  heading?: string;
  description?: string;
  ai_automations: AiAutomationsContent;
};

const defaultContent = (
  await getEntryCTM("sections", "pricing-section", Astro.currentLocale)
)?.data as PricingSectionContent;

const content = overrideObjects(
  defaultContent,
  Astro.props.content,
) as PricingSectionContent;

const { title, subtitle, plans, list, heading, description, ai_automations } =
  content;

const pricingTabs: PricingTabItem[] = plans?.list || [];
const pricingCards: PricingTier[] = list || [];
const aiCtas: Pick<ButtonData, "label" | "url" | "variant">[] =
  ai_automations?.ctas || [];
---

<section id="pricing" class="pricing-dark-teal relative overflow-hidden">
  <div class="pricing-orb pricing-orb-1" aria-hidden="true"></div>
  <div class="pricing-orb pricing-orb-2" aria-hidden="true"></div>
  <!-- background glows -->
  <div aria-hidden class="pointer-events-none absolute inset-0">
    <div
      class="absolute -top-40 left-1/2 h-[600px] w-[800px] -translate-x-1/2 rounded-full bg-[color-mix(in_oklab,oklch(0.61_0.06_205.6)_20%,transparent)] blur-[120px]">
    </div>

    <div
      class="absolute right-[-200px] bottom-0 h-[500px] w-[500px] rounded-full bg-teal-400/20 blur-[120px]">
    </div>
  </div>

  <div class="container space-y-9 md:space-y-12">
    <!-- Title & Subtitle -->
    <div class="mx-auto max-w-2xl space-y-5 text-center">
      {subtitle && <Subtitle content={subtitle} />}
      {
        title && (
          <h2
            class="section-title has-italic-text capitalize"
            set:html={markdownify(title)}
          />
        )
      }
    </div>

    <!-- Tab Buttons -->
    <div class="flex justify-center">
      <div class="pricing-tabs">
        {
          pricingTabs.map((item, index) => (
            <Button
              class="btn-toggle pricing-tab"
              tag="button"
              data-tab-key={index === 0 ? "web" : "ai"}
              data-tab={item.label}
              data-active={item.selected ? "true" : "false"}
              content={{
                enable: true,
                label: item.label,
              }}
              variant="secondary"
            />
          ))
        }
      </div>
    </div>

    <!-- WEB DESIGN CONTENT -->
    <div
      id="web-design-content"
      class:list={[plans?.list?.[0]?.selected ? "block" : "hidden"]}>
      <div class="grid grid-cols-1 gap-8 lg:grid-cols-3 lg:items-start">
        {
          pricingCards.map((item, index) => (
            <PricingCard index={index} content={{ ...item, plans }} />
          ))
        }
      </div>

      {
        heading && (
          <h4
            class="mt-20 text-center font-medium"
            set:html={markdownify(heading)}
          />
        )
      }

      {
        description && (
          <div
            class="mx-auto p-6 text-center"
            set:html={markdownify(description, true)}
          />
        )
      }
    </div>

    <!-- AI AUTOMATIONS CONTENT -->
    <div
      id="ai-content"
      class:list={[plans?.list?.[1]?.selected ? "block" : "hidden"]}
      class="space-y-6 pt-6 pb-6 text-center md:pt-8 md:pb-8">
      <h3 class="mx-auto max-w-3xl text-2xl font-medium tracking-[0.02em] text-mustard md:text-4xl">
        {ai_automations.title}
      </h3>

      <p class="mx-auto max-w-xl text-base text-white/88">
        {ai_automations.subtitle}
      </p>

      <div class="mt-6 flex items-center justify-center gap-4">
        {
          aiCtas.map((btn) => (
            <Button
              content={{
                enable: true,
                label: btn.label,
                url: btn.url,
              }}
              variant={btn.variant || "primary"}
              class="justify-center text-center"
            />
          ))
        }
      </div>
    </div>
  </div>
</section>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const tabs = document.querySelectorAll(".pricing-tab");
    const webDesign = document.getElementById("web-design-content");
    const aiBlock = document.getElementById("ai-content");

    function setActiveTab(activeTab: Element) {
      tabs.forEach((t) => {
        t.setAttribute("data-active", t === activeTab ? "true" : "false");
      });
      const isWebTab = activeTab?.getAttribute("data-tab-key") === "web";
      webDesign?.classList.toggle("hidden", !isWebTab);
      aiBlock?.classList.toggle("hidden", isWebTab);
    }

    tabs.forEach((tab) => {
      tab.addEventListener("click", () => {
        setActiveTab(tab);
      });
    });
  });
</script>
