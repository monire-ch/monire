---
import { getEntryCTM } from "@/lib/contentParser.astro";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import Subtitle from "../widgets/Subtitle.astro";
import type { Section } from "@/types";
import { markdownify } from "@/lib/utils/textConverter";

type ServiceCTA = {
  label: string;
  style?: "primary" | "outline";
  url: string;
};

type ServicesTab = {
  label: string;
  content: string;
  cta?: ServiceCTA[];
};

type ServicesSectionType = Section & {
  tabs?: ServicesTab[];
};

type Props = {
  content?: ServicesSectionType;
};

let defaultContent = (
  await getEntryCTM("sections", "services", Astro.currentLocale)
)?.data as ServicesSectionType;

let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as ServicesSectionType;

let { enable = true, title, subtitle, tabs = [] } = actualContent;
const tabsWithIds = tabs.map((tab, index) => ({
  ...tab,
  tabId: `services-tab-${index}`,
  panelId: `services-panel-${index}`,
}));
---

{
  enable && (
    <section
      id="services"
      class="section-light"
      style="background-image: var(--gradient-bg-light);">
      <div class="container">
        <div class="space-y-12 md:space-y-16">
          <div class="mx-auto max-w-2xl text-center" data-aos="fade-up-sm">
            <Subtitle content={subtitle} />
            {title && (
              <h2
                class="section-title has-italic-text text-monire-deep-teal"
                set:html={markdownify(title)}
              />
            )}
          </div>

          {tabsWithIds.length > 0 && (
            <div data-aos="fade-up-sm" data-aos-delay="300" class="relative">
              <div class="services-shell mx-auto w-full max-w-[1020px] rounded-3xl border p-5 md:p-8 lg:p-10">
                <div class="services-two-col grid gap-6 md:grid-cols-[minmax(210px,0.85fr)_minmax(0,1.55fr)] md:gap-8">
                  <nav
                    class="services-nav md:sticky md:top-28 md:self-start"
                    aria-label="Services Tabs"
                    role="tablist"
                    aria-orientation="vertical">
                    {tabsWithIds.map((tab, index) => (
                      <button
                        type="button"
                        class:list={[
                          "services-tab-button",
                          index === 0 && "active",
                        ]}
                        id={tab.tabId}
                        aria-controls={tab.panelId}
                        role="tab"
                        aria-selected={index === 0 ? "true" : "false"}
                        data-hs-tab={`#${tab.panelId}`}>
                        {tab.label}
                      </button>
                    ))}
                  </nav>

                  <div class="services-panels border-l-0 pl-0 md:border-l md:pl-8">
                    {tabsWithIds.map((tab, index) => (
                      <div
                        id={tab.panelId}
                        class:list={[
                          "services-panel",
                          index !== 0 && "hidden",
                        ]}
                        role="tabpanel"
                        aria-labelledby={tab.tabId}>
                        <div class="services-copy text-left">
                          <h3 class="services-card-title mt-0! mb-4! text-[var(--text-card-title)]">
                            {tab.label}
                          </h3>
                          <div
                            class:list={[
                              "services-prose prose-styles max-w-none",
                            ]}
                            set:html={markdownify(tab.content)}
                          />

                          {tab.cta && tab.cta.length > 0 && (
                            <div class="services-cta-group flex flex-wrap gap-4 pt-5">
                              {tab.cta.map((cta) => (
                                <a
                                  href={cta.url}
                                  class:list={[
                                    "btn text-sm",
                                    cta.style === "outline"
                                      ? "services-cta-outline"
                                      : "services-cta-solid",
                                  ]}>
                                  {cta.label}
                                </a>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  )
}

<script>
  import "@preline/tabs";
</script>

<style>
  .services-shell {
    background: var(--gradient-services-shell);
    border-color: var(--color-services-shell-border-dark);
    box-shadow: var(--shadow-services-shell);
  }

  .services-nav {
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.35rem;
    border-color: var(--color-services-shell-divider);
    border-width: 1px;
    border-style: solid;
    border-radius: 1rem;
    padding: 0.45rem;
    width: 100%;
    background: var(--color-duo-collage-surface);
  }

  .services-tab-button {
    text-align: center;
    border-radius: 0.7rem;
    padding: 0.58rem 0.75rem;
    font-size: 0.92rem;
    line-height: 1.25;
    font-weight: 500;
    color: var(--color-services-tab-text-on-dark);
    transition:
      color 180ms ease,
      background-color 180ms ease,
      box-shadow 180ms ease;
  }

  .services-tab-button:hover {
    color: var(--color-services-tab-active-on-dark);
    background: var(--color-duo-collage-glow-a);
  }

  .services-tab-button.active {
    color: var(--color-services-tab-active-on-dark);
    background: var(--color-duo-collage-border);
    box-shadow: inset 0 0 0 1px var(--color-services-shell-divider);
  }

  .services-tab-button:focus-visible {
    outline: 2px solid var(--color-link-dark-bg);
    outline-offset: 2px;
  }

  .services-copy {
    padding-top: 0.15rem;
  }

  .services-card-title {
    line-height: 1.08;
    color: var(--color-light);
  }

  .services-copy .prose-styles a {
    color: var(--color-link-dark-bg);
  }

  .services-prose.prose-styles p,
  .services-prose.prose-styles li {
    color: var(--color-services-tab-text-on-dark);
  }

  .services-prose.prose-styles h1,
  .services-prose.prose-styles h2,
  .services-prose.prose-styles h3,
  .services-prose.prose-styles h4,
  .services-prose.prose-styles h5,
  .services-prose.prose-styles h6 {
    color: var(--color-services-tab-active-on-dark);
  }

  .services-copy .prose-styles a:hover {
    color: var(--color-link-dark-bg-hover);
  }

  .services-cta-solid,
  .services-cta-outline {
    border: 1px solid transparent;
  }

  .services-cta-solid {
    background: var(--color-mustard);
    color: var(--color-monire-ink);
  }

  .services-cta-solid:hover {
    background: var(--color-link-dark-bg-hover);
  }

  .services-cta-outline {
    border-color: var(--color-services-shell-divider);
    color: var(--color-light);
    background: transparent;
  }

  .services-cta-outline:hover {
    background: var(--color-duo-collage-glow-a);
  }

  .services-panels {
    border-color: var(--color-services-shell-divider);
  }

  @media (min-width: 768px) {
    .services-nav {
      flex-direction: column;
      gap: 0.4rem;
    }

    .services-tab-button {
      text-align: left;
    }

    .services-panels {
      padding-top: 0.65rem;
    }
  }
</style>
