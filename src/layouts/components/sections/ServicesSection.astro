---
import { getEntryCTM } from "@/lib/contentParser.astro";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import Subtitle from "../widgets/Subtitle.astro";
import type { Section } from "@/types";
import { markdownify } from "@/lib/utils/textConverter";

type ServiceCTA = {
  label: string;
  style?: "primary" | "outline";
  url: string;
};

type ServicesTab = {
  label: string;
  content: string;
  cta?: ServiceCTA[];
};

type ServicesSectionType = Section & {
  tabs?: ServicesTab[];
};

type Props = {
  content?: ServicesSectionType;
};

let defaultContent = (
  await getEntryCTM("sections", "services", Astro.currentLocale)
)?.data as ServicesSectionType;

let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as ServicesSectionType;

let { enable = true, title, subtitle, tabs = [] } = actualContent;
const tabsWithIds = tabs.map((tab, index) => ({
  ...tab,
  tabId: `services-tab-${index}`,
  panelId: `services-panel-${index}`,
}));
---

{
  enable && (
    <section
      id="services"
      class="section-light"
      style="background-image: var(--gradient-bg-light);">
      <div class="container">
        <div class="space-y-12 md:space-y-16">
          <div class="mx-auto max-w-2xl text-center" data-aos="fade-up-sm">
            <Subtitle content={subtitle} />
            {title && (
              <h2
                class="section-title has-italic-text text-monire-deep-teal"
                set:html={markdownify(title)}
              />
            )}
          </div>

          {tabsWithIds.length > 0 && (
            <div data-aos="fade-up-sm" data-aos-delay="300" class="relative">
              <div class="services-shell mx-auto w-full max-w-[1120px] rounded-3xl border p-5 md:p-8 lg:p-10">
                <nav
                  class="services-nav border-b pb-3 md:pb-4"
                  aria-label="Services Tabs"
                  role="tablist"
                  aria-orientation="horizontal">
                  {tabsWithIds.map((tab, index) => (
                    <button
                      type="button"
                      class:list={[
                        "services-tab-button",
                        index === 0 && "active",
                      ]}
                      id={tab.tabId}
                      aria-controls={tab.panelId}
                      role="tab"
                      aria-selected={index === 0 ? "true" : "false"}
                      data-hs-tab={`#${tab.panelId}`}>
                      {tab.label}
                    </button>
                  ))}
                </nav>

                <div class="pt-6 md:pt-8">
                  {tabsWithIds.map((tab, index) => (
                    <div
                      id={tab.panelId}
                      class:list={[
                        "services-panel",
                        index !== 0 && "hidden",
                      ]}
                      role="tabpanel"
                      aria-labelledby={tab.tabId}>
                      <div class="services-copy mx-auto max-w-4xl text-left">
                        <h3 class="services-card-title mt-0! mb-4! text-[var(--text-card-title)]">
                          {tab.label}
                        </h3>
                        <div
                          class:list={[
                            "prose-styles max-w-none",
                            "prose-p:text-white/88 prose-headings:text-white prose-li:text-white/88",
                          ]}
                          set:html={markdownify(tab.content)}
                        />

                        {tab.cta && tab.cta.length > 0 && (
                          <div class="services-cta-group flex flex-wrap gap-4 pt-5">
                            {tab.cta.map((cta) => (
                              <a
                                href={cta.url}
                                class:list={[
                                  "btn text-sm",
                                  cta.style === "outline"
                                    ? "services-cta-outline"
                                    : "services-cta-solid",
                                ]}>
                                {cta.label}
                              </a>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  )
}

<script>
  import "@preline/tabs";
</script>

<style>
  .services-shell {
    background: var(--gradient-services-shell);
    border-color: var(--color-services-shell-border-dark);
    box-shadow: var(--shadow-services-shell);
  }

  .services-nav {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 0.35rem 1rem;
    border-color: var(--color-services-shell-divider);
  }

  .services-tab-button {
    position: relative;
    padding: 0.4rem 0.15rem 0.7rem;
    font-size: 0.92rem;
    font-weight: 500;
    color: var(--color-services-tab-text-on-dark);
    transition: color 180ms ease;
  }

  .services-tab-button::after {
    content: "";
    position: absolute;
    left: 0;
    bottom: -0.2rem;
    width: 100%;
    height: 2px;
    border-radius: 999px;
    background: transparent;
    transition: background-color 180ms ease;
  }

  .services-tab-button.active {
    color: var(--color-services-tab-active-on-dark);
  }

  .services-tab-button.active::after {
    background: var(--color-mustard);
  }

  .services-copy {
    padding-top: 0.25rem;
  }

  .services-card-title {
    line-height: 1.08;
    color: var(--color-services-card-featured-heading);
  }

  .services-copy .prose-styles a {
    color: var(--color-link-dark-bg);
  }

  .services-copy .prose-styles a:hover {
    color: var(--color-link-dark-bg-hover);
  }

  .services-cta-solid,
  .services-cta-outline {
    border: 1px solid transparent;
  }

  .services-cta-solid {
    background: var(--color-mustard);
    color: var(--color-monire-ink);
  }

  .services-cta-solid:hover {
    background: var(--color-link-dark-bg-hover);
  }

  .services-cta-outline {
    border-color: rgba(248, 245, 241, 0.36);
    color: var(--color-light);
    background: transparent;
  }

  .services-cta-outline:hover {
    background: rgba(248, 245, 241, 0.1);
  }
</style>
