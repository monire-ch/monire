---
import { getEntryCTM } from "@/lib/contentParser.astro";
import overrideObjects from "@/lib/utils/overrideObjects.ts";
import Subtitle from "../widgets/Subtitle.astro";
import type { Section } from "@/types";
import { markdownify } from "@/lib/utils/textConverter";
import Button from "@/layouts/components/buttons/Button.astro";

type ServiceCTA = {
  label: string;
  variant?: "primary" | "secondary";
  url: string;
};

type ServicesTab = {
  label: string;
  content: string;
  cta?: ServiceCTA[];
};

type ServicesSectionType = Section & {
  tabs?: ServicesTab[];
};

type Props = {
  content?: ServicesSectionType;
};

let defaultContent = (
  await getEntryCTM("sections", "services", Astro.currentLocale)
)?.data as ServicesSectionType;

let actualContent = overrideObjects(
  { ...defaultContent },
  Astro.props.content,
) as ServicesSectionType;

let { enable = true, title, subtitle, tabs = [] } = actualContent;
const tabsWithIds = tabs.map((tab, index) => ({
  ...tab,
  tabId: `services-tab-${index}`,
  panelId: `services-panel-${index}`,
  step: String(index + 1).padStart(2, "0"),
}));
---

{
  enable && (
    <section
      id="services"
      class="section-light"
      style="background-color: var(--color-bg-page);">
      <div class="container">
        <div class="space-y-12 md:space-y-16">
          <div class="mx-auto max-w-2xl text-center" data-aos="fade-up-sm">
            <Subtitle content={subtitle} />
            {title && (
              <h2
                class="section-title has-italic-text text-monire-deep-teal"
                set:html={markdownify(title)}
              />
            )}
          </div>

          {tabsWithIds.length > 0 && (
            <div data-aos="fade-up-sm" data-aos-delay="300" class="relative">
              <div class="services-shell mx-auto w-full max-w-[1160px] rounded-[1.55rem] border p-5 md:p-8 lg:p-9">
                <div class="services-mobile-accordion md:hidden">
                  {tabsWithIds.map((tab, index) => (
                    <details class="services-mobile-item" open={index === 0}>
                      <summary class="services-mobile-summary">
                        <span class="services-mobile-label">{tab.label}</span>
                        <span class="services-mobile-icon" aria-hidden="true"></span>
                      </summary>

                      <div class="services-content text-left">
                        <div
                          class:list={[
                            "services-prose prose-styles max-w-none",
                          ]}
                          set:html={markdownify(tab.content)}
                        />

                        {tab.cta && tab.cta.length > 0 && (
                          <div class="services-cta-group flex flex-wrap gap-4 pt-5">
                            {tab.cta.map((cta) => (
                              <Button
                                variant={cta.variant || "primary"}
                                class="text-center"
                                content={{
                                  enable: true,
                                  label: cta.label,
                                  url: cta.url,
                                }}
                              />
                            ))}
                          </div>
                        )}
                      </div>
                    </details>
                  ))}
                </div>

                <div class="hidden services-timeline gap-6 md:grid md:grid-cols-[minmax(280px,0.8fr)_minmax(0,2fr)] md:gap-8">
                  <nav
                    class="services-timeline-nav"
                    aria-label="Services Timeline"
                    role="tablist"
                    aria-orientation="vertical">
                    {tabsWithIds.map((tab, index) => (
                      <Button
                        tag="button"
                        class:list={[
                          "services-timeline-item btn-toggle",
                          index === 0 && "active",
                        ]}
                        id={tab.tabId}
                        aria-controls={tab.panelId}
                        role="tab"
                        aria-selected={index === 0 ? "true" : "false"}
                        data-hs-tab={`#${tab.panelId}`}
                        content={{
                          enable: true,
                          label: tab.label,
                        }}
                        variant="secondary"
                      />
                    ))}
                  </nav>

                  <div class="services-panels border-l-0 pl-0 md:border-l md:pt-4 md:pl-12 md:pr-8 lg:pt-5 lg:pl-14 lg:pr-12">
                    {tabsWithIds.map((tab, index) => (
                      <div
                        id={tab.panelId}
                        class:list={[
                          "services-panel",
                          index !== 0 && "hidden",
                        ]}
                        role="tabpanel"
                        aria-labelledby={tab.tabId}>
                        <div class="services-content text-left">
                          <h3 class="services-card-title mt-0! text-[var(--text-card-title)]">
                            {tab.label}
                          </h3>
                          <div
                            class:list={[
                              "services-prose prose-styles max-w-none",
                            ]}
                            set:html={markdownify(tab.content)}
                          />

                          {tab.cta && tab.cta.length > 0 && (
                            <div class="services-cta-group flex flex-wrap gap-4 pt-5">
                              {tab.cta.map((cta) => (
                                <Button
                                  variant={cta.variant || "primary"}
                                  class="text-center"
                                  content={{
                                    enable: true,
                                    label: cta.label,
                                    url: cta.url,
                                  }}
                                />
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </section>
  )
}

<script>
  import "@preline/tabs";
</script>

<style>
  .services-shell {
    background: var(--gradient-surface-dark);
    border-color: var(--color-border-surface-dark);
    box-shadow: 0 18px 34px rgba(3, 42, 52, 0.16);
  }

  .services-mobile-item {
    border-bottom: 1px solid color-mix(in srgb, var(--color-border-surface-dark) 85%, transparent);
  }

  .services-mobile-item:first-child {
    border-top: 1px solid color-mix(in srgb, var(--color-border-surface-dark) 85%, transparent);
  }

  .services-mobile-summary {
    list-style: none;
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem 0.15rem;
    cursor: pointer;
  }

  .services-mobile-summary::-webkit-details-marker {
    display: none;
  }

  .services-mobile-label {
    color: var(--color-text-shell-strong);
    font-size: 1rem;
    line-height: 1.3;
    font-weight: 500;
  }

  .services-mobile-icon {
    position: relative;
    width: 1rem;
    height: 1rem;
  }

  .services-mobile-icon::before,
  .services-mobile-icon::after {
    content: "";
    position: absolute;
    left: 0;
    top: 50%;
    width: 100%;
    height: 1.5px;
    border-radius: 999px;
    background: color-mix(in srgb, white 72%, transparent);
    transform: translateY(-50%);
    transition: transform 180ms ease;
  }

  .services-mobile-icon::after {
    transform: translateY(-50%) rotate(90deg);
  }

  .services-mobile-item[open] .services-mobile-icon::after {
    transform: translateY(-50%) rotate(0deg);
  }

  .services-timeline-nav {
    display: flex;
    flex-direction: column;
    gap: 0.62rem;
    padding: 0.2rem 0.12rem;
  }

  .services-timeline-item {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 0.55rem;
    text-align: left;
    width: calc(100% - 1rem);
    margin-inline: auto;
    transition:
      color 180ms ease,
      background-color 180ms ease,
      border-color 180ms ease;
  }

  .services-timeline-item:focus-visible {
    outline: 2px solid var(--color-mustard);
    outline-offset: 2px;
    border-radius: 9999px;
  }

  .services-panels {
    border-color: color-mix(in srgb, var(--color-border-surface-dark) 82%, transparent);
  }

  .services-content {
    padding: 0.6rem 0.8rem 0.8rem;
  }

  .services-card-title {
    line-height: 1.06;
    color: var(--color-text-shell-strong);
    font-size: clamp(2rem, 1.55rem + 0.95vw, 3.1rem);
    letter-spacing: -0.014em;
    margin-bottom: 0 !important;
  }

  .services-prose.prose-styles {
    margin-top: 2rem;
  }

  .services-content .prose-styles a {
    color: var(--color-link-dark-bg);
    text-decoration: underline;
    text-underline-offset: 0.16em;
  }

  .services-prose.prose-styles p,
  .services-prose.prose-styles li {
    color: var(--color-text-shell-muted);
    max-width: 54ch;
    font-size: clamp(1.08rem, 1.02rem + 0.16vw, 1.22rem);
    line-height: 1.7;
  }

  .services-prose.prose-styles h1,
  .services-prose.prose-styles h2,
  .services-prose.prose-styles h3,
  .services-prose.prose-styles h4,
  .services-prose.prose-styles h5,
  .services-prose.prose-styles h6 {
    color: var(--color-text-shell-strong);
  }

  .services-content .prose-styles a:hover {
    color: var(--color-link-dark-bg-hover);
  }

  @media (max-width: 767px) {
    .services-shell {
      border-radius: 1.2rem;
    }

    .services-content {
      padding-left: 0;
      padding-right: 0;
      padding-top: 0.2rem;
      padding-bottom: 1.1rem;
    }
  }
</style>
