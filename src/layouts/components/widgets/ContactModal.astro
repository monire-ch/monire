---
import ContactSection from "@/layouts/components/sections/ContactSection.astro";
import { getEntryCTM } from "@/lib/contentParser.astro";

const contactPage = await getEntryCTM("contact", "-index", Astro.currentLocale);
const modalHeading = contactPage?.data?.pageHeading || "Let's Work Together";
---

<style>
  .modal-overlay {
    transition:
      opacity 0.3s ease,
      backdrop-filter 0.3s ease;
    backdrop-filter: blur(0rem);
  }

  .modal-overlay.active {
    backdrop-filter: blur(0.5rem);
  }

  .modal-panel {
    opacity: 1;
    transition:
      transform 0.42s cubic-bezier(0.22, 0.9, 0.22, 1),
      opacity 0.28s ease;
    will-change: transform, opacity;
  }

  .modal-panel.translate-x-full {
    opacity: 0;
  }

  .contact-modal-panel {
    background: var(--gradient-dark-teal);
    border-left: 1px solid var(--color-border-surface-dark);
    color: color-mix(in srgb, white 90%, transparent);
  }

  .contact-modal-title {
    color: white;
  }

  .contact-modal-close {
    color: white;
    background: transparent;
    border: 0;
  }

  .contact-modal-close:hover {
    color: white;
    background: transparent;
  }

  .contact-modal-panel :global(section.section-light) {
    background: transparent;
    color: inherit;
  }

  .contact-modal-panel :global(.container) {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  .contact-modal-panel :global([data-aos][data-aos-delay="200"]) {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  .contact-modal-panel :global(.form-label) {
    color: color-mix(in srgb, white 88%, transparent);
  }

  .contact-modal-panel :global(.form-input),
  .contact-modal-panel :global(.hs-select input.form-input),
  .contact-modal-panel :global(.hs-select button.form-input),
  .contact-modal-panel :global(.hs-dropdown) {
    background: color-mix(in srgb, white 8%, transparent);
    border-color: color-mix(in srgb, white 24%, transparent);
    color: white;
  }

  .contact-modal-panel :global(input.form-input:-webkit-autofill),
  .contact-modal-panel :global(input.form-input:-webkit-autofill:hover),
  .contact-modal-panel :global(input.form-input:-webkit-autofill:focus),
  .contact-modal-panel :global(textarea.form-input:-webkit-autofill),
  .contact-modal-panel :global(textarea.form-input:-webkit-autofill:hover),
  .contact-modal-panel :global(textarea.form-input:-webkit-autofill:focus) {
    -webkit-text-fill-color: white !important;
    caret-color: white;
    box-shadow: 0 0 0 1000px color-mix(in srgb, white 8%, transparent) inset !important;
    border-color: color-mix(in srgb, white 24%, transparent) !important;
    transition: background-color 9999s ease-out 0s;
  }

  .contact-modal-panel :global(#validation-target) {
    position: relative;
    z-index: 40;
  }

  .contact-modal-panel :global(#validation-target:has([aria-expanded="true"])) {
    z-index: 2600;
  }

  .contact-modal-panel :global(.hs-dropdown) {
    z-index: 3200 !important;
    background: color-mix(
      in srgb,
      var(--color-bg-dark) 78%,
      var(--color-monire-deep-teal)
    );
    border-color: color-mix(in srgb, white 28%, transparent);
    box-shadow: 0 1.25rem 2.5rem rgba(1, 22, 29, 0.6);
    backdrop-filter: blur(0.25rem);
  }

  .contact-modal-panel :global([data-hs-select-dropdown]) {
    z-index: 3200 !important;
  }

  .contact-modal-panel :global(.hs-dropdown-search-item) {
    color: color-mix(in srgb, white 90%, transparent);
  }

  .contact-modal-panel :global(.hs-dropdown-search-item:hover),
  .contact-modal-panel :global(.hs-dropdown-search-item:focus) {
    color: white;
    background-color: color-mix(
      in srgb,
      var(--color-monire-deep-teal) 58%,
      transparent
    );
  }

  .contact-modal-panel :global(.form-input::placeholder),
  .contact-modal-panel :global(.hs-select input.form-input::placeholder),
  .contact-modal-panel :global(.hs-select button.form-input::placeholder) {
    color: color-mix(in srgb, white 58%, transparent);
  }

  .contact-modal-panel
    :global(.hs-select button.form-input .text-text-default),
  .contact-modal-panel :global(.hs-select button.form-input > span.truncate) {
    color: color-mix(in srgb, white 58%, transparent) !important;
  }

  .contact-modal-panel :global(.form-checkbox) {
    color: var(--color-light);
    border-color: color-mix(in srgb, white 72%, transparent);
  }

  .contact-modal-panel :global(.form-checkbox:checked) {
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 14 11' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1.5 5.5L5.5 9.5L12.5 1.5' fill='none' stroke='%23f8f5f1' stroke-width='2.2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    border-color: color-mix(in srgb, white 82%, transparent);
    background-color: transparent;
  }

  .contact-modal-panel :global(.btn-primary) {
    background: color-mix(
      in srgb,
      var(--color-monire-deep-teal) 88%,
      white
    );
    color: var(--color-light);
    border: 1px solid var(--color-mustard-70);
    box-shadow: none !important;
  }

  .contact-modal-panel :global(.btn-primary:hover) {
    background: color-mix(
      in srgb,
      var(--color-monire-deep-teal) 96%,
      white
    );
    border-color: var(--color-mustard);
    box-shadow: none !important;
  }

  .contact-modal-panel :global(.btn-primary:focus),
  .contact-modal-panel :global(.btn-primary:focus-visible),
  .contact-modal-panel :global(.btn-primary:active) {
    box-shadow: none !important;
  }

  .contact-modal-panel :global(.prose-a\:text-primary a),
  .contact-modal-panel :global(.text-link),
  .contact-modal-panel :global(form a) {
    color: var(--color-link-dark-bg) !important;
    text-decoration-thickness: var(--color-link-underline-thickness);
    text-underline-offset: 0.15em;
  }

  .contact-modal-panel :global(.prose-a\:text-primary a:hover),
  .contact-modal-panel :global(.text-link:hover),
  .contact-modal-panel :global(form a:hover) {
    color: var(--color-link-dark-bg-hover) !important;
  }

  :global(body.modal-open) {
    overflow: hidden;
    padding-right: var(--scrollbar-width, 0);
  }

  :global(body.modal-open) {
    position: fixed;
    width: 100%;
  }
</style>

<div
  id="contactOverlay"
  class="modal-overlay pointer-events-none fixed inset-0 z-999 bg-black/50 opacity-0">
</div>

<div
  id="contactPanel"
  class="modal-panel contact-modal-panel fixed top-0 right-0 z-1000 flex h-full w-full translate-x-full flex-col overflow-y-auto p-8 shadow-2xl sm:w-[30rem] md:p-10">
  <button
    id="closeModalBtn"
    class="contact-modal-close absolute top-4 right-4 flex h-9 w-9 items-center justify-center text-2xl transition-colors"
    aria-label="Close modal">
    âœ•
  </button>

  <h2 class="contact-modal-title text-4xl text-light mb-8 mt-6">{modalHeading}</h2>

  <ContactSection />
  <slot />
</div>

<script>
  function initContactModal() {
    const overlay = document.getElementById("contactOverlay");
    const panel = document.getElementById("contactPanel");
    const closeBtn = document.getElementById("closeModalBtn");

    const getScrollbarWidth = () => {
      const outer = document.createElement("div");
      outer.style.visibility = "hidden";
      outer.style.overflow = "scroll";
      document.body.appendChild(outer);

      const inner = document.createElement("div");
      outer.appendChild(inner);

      const scrollbarWidth = outer.offsetWidth - inner.offsetWidth;
      outer.parentNode?.removeChild(outer);

      return scrollbarWidth;
    };

    const open = () => {
      if (panel && overlay) {
        const scrollY = window.scrollY;

        const scrollbarWidth = getScrollbarWidth();
        document.documentElement.style.setProperty(
          "--scrollbar-width",
          `${scrollbarWidth}px`,
        );

        document.body.classList.add("modal-open");
        document.body.style.top = `-${scrollY}px`;

        panel.scrollTo({ top: 0, behavior: "auto" });
        panel.classList.remove("translate-x-full");
        overlay.classList.remove("opacity-0", "pointer-events-none");
        overlay.classList.add("opacity-100", "pointer-events-auto", "active");

        document.body.setAttribute("data-scroll-y", scrollY.toString());
      }
    };

    const close = () => {
      if (panel && overlay) {
        const scrollY = document.body.getAttribute("data-scroll-y");
        const scrollPosition = scrollY ? parseInt(scrollY) : null;

        panel.classList.add("translate-x-full");
        overlay.classList.remove(
          "opacity-100",
          "pointer-events-auto",
          "active",
        );
        overlay.classList.add("opacity-0", "pointer-events-none");

        const html = document.documentElement;
        const originalScrollBehavior = html.style.scrollBehavior;
        html.style.scrollBehavior = "auto";

        if (scrollPosition !== null) {
          document.body.classList.remove("modal-open");
          document.body.style.top = "";
          document.documentElement.style.removeProperty("--scrollbar-width");

          window.scrollTo(0, scrollPosition);

          requestAnimationFrame(() => {
            html.style.scrollBehavior = originalScrollBehavior;
            document.body.removeAttribute("data-scroll-y");
          });
        } else {
          document.body.classList.remove("modal-open");
          document.body.style.top = "";
          document.documentElement.style.removeProperty("--scrollbar-width");
        }
      }
    };

    document.querySelectorAll("[data-open-contact]").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        open();
      });
    });

    window.addEventListener("open-contact-modal", open);

    overlay?.addEventListener("click", close);

    closeBtn?.addEventListener("click", close);

    document.addEventListener("keydown", (e) => {
      if (
        e.key === "Escape" &&
        document.body.classList.contains("modal-open")
      ) {
        close();
      }
    });
  }

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", initContactModal);
  } else {
    initContactModal();
  }
</script>
