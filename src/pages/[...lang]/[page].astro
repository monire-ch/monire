---
import Base from "@/layouts/Base.astro";
import dateFormat from "@/lib/utils/dateFormat";
import { markdownify } from "@/lib/utils/textConverter";
import { getCollectionCTM } from "@/lib/contentParser.astro";
import { supportedLanguages, useTranslations } from "@/lib/utils/i18nUtils";
import CallToAction from "@/components/sections/CallToAction.astro";
import config from ".astro/config.generated.json" with { type: "json" };

// get static paths for all pages
export async function getStaticPaths() {
  const paths = await Promise.all(
    supportedLanguages.map(async (lang) => {
      const { defaultLanguage, showDefaultLangInUrl } =
        config.settings.multilingual;

      let pages = await getCollectionCTM("pages", lang.languageCode);

      return pages.map((page) => ({
        params: {
          lang:
            lang.languageCode === defaultLanguage && !showDefaultLangInUrl
              ? undefined
              : lang.languageCode,
          page:
            page.data?.customSlug ||
            page.id
              .replace(/\.mdx?|\.md/g, "")
              .split("/")
              .pop(),
        },
        props: {
          page,
        },
      }));
    }),
  );

  return paths.flat();
}

const { page } = Astro.props;
const { title, date } = page.data;
const { Content } = await page.render();
const pageTheme = page.data.theme || "default";
const isDarkTealTheme = pageTheme === "darkTeal";

const t = await useTranslations(Astro.currentLocale as string);
---

<Base {...page.data}>
  <section class:list={["section-light", isDarkTealTheme && "page-theme-dark-teal dark-teal-theme-base"]}>
    {isDarkTealTheme && <div class="dark-teal-theme-orb dark-teal-theme-orb-1" aria-hidden="true"></div>}
    {isDarkTealTheme && <div class="dark-teal-theme-orb dark-teal-theme-orb-2" aria-hidden="true"></div>}
    <div class="container">
      <div class="has-video-modal mx-auto max-w-5xl" data-aos="fade-up-sm">
        {
          title && (
            <h1
              class:list={[
                "text-4xl",
                isDarkTealTheme ? "text-light" : "text-monire-deep-teal",
              ]}
              set:html={markdownify(title)}
            />
          )
        }
        <div class="mt-8 flex">
          {
            date && (
              <div class="flex flex-col gap-y-4">
                <p class="font-primary text-sm tracking-[.12em] opacity-60">
                  {t("common.publishedOn")}
                </p>
                <p
                  class:list={[
                    "text-sm font-medium",
                    isDarkTealTheme && "page-theme-date",
                  ]}
                  set:html={dateFormat(date)}
                />
              </div>
            )
          }
        </div>
        <div
          class:list={[
            "prose-styles content-page-prose lg:text-lg",
            isDarkTealTheme && "page-theme-prose",
            date ? "mt-10 md:mt-20" : "mt-5 md:mt-10",
          ]}>
          <Content />
        </div>
      </div>
    </div>
  </section>
  <CallToAction />
</Base>

<style is:global>
  .page-theme-dark-teal .container,
  .page-theme-dark-teal .has-video-modal {
    position: relative;
    z-index: 1;
  }

  .page-theme-dark-teal .has-video-modal {
    padding: 0;
  }

  .page-theme-dark-teal,
  .page-theme-dark-teal p,
  .page-theme-dark-teal li,
  .page-theme-dark-teal a,
  .page-theme-dark-teal .font-primary {
    color: var(--color-text-shell-muted) !important;
  }

  .page-theme-dark-teal .page-theme-date {
    color: color-mix(in srgb, white 84%, transparent);
  }

  .page-theme-dark-teal .page-theme-prose {
    max-width: 65ch;
  }

  .page-theme-dark-teal .prose-styles p,
  .page-theme-dark-teal .prose-styles li,
  .page-theme-dark-teal .prose-styles ol > li {
    color: var(--color-text-shell-muted) !important;
    line-height: 1.72;
  }

  .page-theme-dark-teal .prose-styles h1,
  .page-theme-dark-teal .prose-styles h2,
  .page-theme-dark-teal .prose-styles h3,
  .page-theme-dark-teal .prose-styles h4,
  .page-theme-dark-teal .prose-styles h5,
  .page-theme-dark-teal .prose-styles h6,
  .page-theme-dark-teal .prose-styles strong,
  .page-theme-dark-teal .prose-styles b {
    color: var(--color-text-shell-strong) !important;
  }

  .page-theme-dark-teal .page-theme-prose h2 {
    margin-top: 2.6rem;
    padding-top: 1.35rem;
    border-top: 1px solid color-mix(in srgb, var(--color-divider-shell) 92%, transparent);
  }

  .page-theme-dark-teal .page-theme-prose h3 {
    margin-top: 2.35rem;
    padding-top: 1.15rem;
    border-top: 1px solid color-mix(in srgb, var(--color-divider-shell) 92%, transparent);
  }

  .page-theme-dark-teal .page-theme-prose h3:first-of-type {
    margin-top: 1.75rem;
    padding-top: 0;
    border-top: 0;
  }

  .page-theme-dark-teal .page-theme-prose p + p,
  .page-theme-dark-teal .page-theme-prose ul + p,
  .page-theme-dark-teal .page-theme-prose ol + p {
    margin-top: 0.95rem;
  }

  .page-theme-dark-teal .page-theme-prose ul:not(.list-unstyled) li::marker {
    color: color-mix(in srgb, white 82%, transparent);
  }

  .page-theme-dark-teal .prose-styles a {
    color: var(--color-link-dark-bg) !important;
    text-decoration: none;
  }

  .page-theme-dark-teal .prose-styles a:hover {
    color: var(--color-link-dark-bg-hover) !important;
    text-decoration: underline;
  }

  .page-theme-dark-teal .prose-styles a:focus-visible {
    color: var(--color-link-dark-bg-hover) !important;
    text-decoration: underline;
    outline-color: var(--color-link-dark-bg-focus);
  }

</style>
